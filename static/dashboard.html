<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentSDR Dashboard - AI Sales Development Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f8fafc;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .animated-gradient {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hover-scale {
            transition: all 0.3s ease;
        }

        .hover-scale:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .metric-card:hover::before {
            left: 100%;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #fff;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .activity-item {
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            border-left-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .notification-dot {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .quick-action {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
            min-width: 0;
            display: block;
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .agent-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .agent-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: #10b981; }
        .status-offline { background: #6b7280; }
        .status-busy { background: #f59e0b; }

        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }

        .dark-mode {
            --light: #1f2937;
            --dark: #f8fafc;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            width: 60px;
            height: 30px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle.dark::before {
            transform: translateX(30px);
            background: #1f2937;
        }

        /* Settings Navigation Styles */
        .settings-nav-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .settings-nav-item:hover {
            background: rgba(79, 70, 229, 0.1);
            border-color: rgba(79, 70, 229, 0.2);
            color: #4f46e5;
            transform: translateX(4px);
        }

        .settings-nav-item.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .settings-nav-item.active:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .settings-nav-item i {
            transition: all 0.3s ease;
        }

        .settings-nav-item.active i {
            color: white;
        }

        /* Settings Content Styles */
        .settings-content {
            transition: all 0.3s ease;
        }

        .settings-content.hidden {
            display: none;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4f46e5;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        #orgEmptyState { display: none; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-72 sidebar z-50 transform transition-transform duration-300">
        <div class="p-6">
            <div class="flex items-center mb-8">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-3">
                    <i class="fas fa-microphone-alt text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-white text-xl font-bold">AgentSDR</h1>
                    <p class="text-white/70 text-sm">Voice Assistant Platform</p>
                </div>
            </div>

            <!-- Breadcrumb Navigation -->
            <div class="mb-4 p-3 glassmorphism rounded-lg" id="breadcrumbNav">
                <div class="flex items-center text-gray-700 text-sm">
                    <span id="currentLevel">Enterprise</span>
                    <i class="fas fa-chevron-right mx-2 text-xs" id="breadcrumbArrow" style="display: none;"></i>
                    <span id="currentItem" style="display: none;"></span>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="#" class="nav-item active flex items-center p-3 text-white" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-pie mr-3"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('organizations')">
                    <i class="fas fa-building mr-3"></i>
                    <span>Organizations</span>
                    <span class="ml-auto bg-blue-500 text-xs px-2 py-1 rounded-full" id="orgNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('channels')" id="channelsNav" style="display: none;">
                    <i class="fas fa-satellite-dish mr-3 ml-4"></i>
                    <span>Channels</span>
                    <span class="ml-auto bg-purple-500 text-xs px-2 py-1 rounded-full" id="channelNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('agents')" id="agentsNav" style="display: none;">
                    <i class="fas fa-robot mr-3 ml-8"></i>
                    <span>Voice Agents</span>
                    <span class="ml-auto bg-green-500 text-xs px-2 py-1 rounded-full" id="agentNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('contacts')" id="contactsNav" style="display: none;">
                    <i class="fas fa-address-book mr-3 ml-12"></i>
                    <span>Contacts</span>
                    <span class="ml-auto bg-orange-500 text-xs px-2 py-1 rounded-full" id="contactNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('crmContacts')">
                    <i class="fas fa-cloud mr-3"></i>
                    <span>CRM Contacts</span>
                    <span class="ml-auto bg-blue-500 text-xs px-2 py-1 rounded-full" id="crmContactNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('phone-numbers')">
                    <i class="fas fa-phone mr-3"></i>
                    <span>My Phone Numbers</span>
                    <span class="ml-auto bg-cyan-500 text-xs px-2 py-1 rounded-full" id="phoneNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('analytics')">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('settings')">
                    <i class="fas fa-cog mr-3"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="mt-8 p-4 glassmorphism rounded-xl">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="text-gray-800 font-medium user-name">Loading...</p>
                        <p class="text-gray-600 text-sm user-email">Loading...</p>
                        <span class="user-role px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">USER</span>
                    </div>
                </div>
                <button onclick="signOut()" class="w-full py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-72 min-h-screen">
        <!-- Header -->
        <header class="glassmorphism border-b border-white/20 p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Welcome Back! 👋</h1>
                    <p class="text-gray-600">Here's what's happening with your AI assistants today</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="theme-toggle" onclick="toggleTheme()"></div>
                    <button onclick="showNotifications()" class="relative p-3 glassmorphism rounded-full hover:bg-white/20 transition-colors">
                        <i class="fas fa-bell text-gray-700"></i>
                        <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white text-xs flex items-center justify-center notification-dot">3</span>
                    </button>
                    <button onclick="showGlobalSearch()" class="p-3 glassmorphism rounded-full hover:bg-white/20 transition-colors">
                        <i class="fas fa-search text-gray-700"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active p-6">
            <!-- Quick Actions -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4" style="width: 100%;">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                      <button class="quick-action" onclick="window.location.href='/agent-setup.html'">
                        <i class="fas fa-robot mr-2"></i>
                        Setup Voice Agent
                    </button>
                    <button class="quick-action" onclick="window.location.href='/create-agent.html'">
                        <i class="fas fa-robot mr-2"></i>
                        Create New Agent</button>
                    <button class="quick-action" onclick="window.location.href='/contact-management.html'">Manage Contacts</button>
                    <button class="quick-action"onclick="window.location.href='/universal-prompt-editor.html'">Edit AI Prompts</button>
                    <button class="quick-action" onclick="showCallsModal()">
                        <i class="fas fa-phone mr-2"></i>
                        Start Campaign
                    </button>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale" onclick="showSection('organizations')" style="cursor: pointer;">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+12% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="orgCount">0</h3>
                    <p class="text-gray-600">Organizations</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 70%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-satellite-dish text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+15% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="channelCount">0</h3>
                    <p class="text-gray-600">Channels</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: 60%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+8% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="agentCount">0</h3>
                    <p class="text-gray-600">Voice Agents</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+24% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="contactCount">0</h3>
                    <p class="text-gray-600">Total Contacts</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 92%"></div>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Call Volume Trends</h3>
                    <div class="chart-container">
                        <canvas id="callVolumeChart"></canvas>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Agent Performance</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity & Active Agents -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                    <div class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Sales Agent completed call</p>
                                    <p class="text-gray-500 text-sm">Customer: राजेश कुमार • 2 minutes ago</p>
                                </div>
                                <span class="text-green-500 text-sm">Success</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">New contact added to Support Team</p>
                                    <p class="text-gray-500 text-sm">Contact: प्रिया शर्मा • 5 minutes ago</p>
                                </div>
                                <span class="text-blue-500 text-sm">New</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Follow-up Reminder scheduled</p>
                                    <p class="text-gray-500 text-sm">Campaign: Customer Check-in • 10 minutes ago</p>
                                </div>
                                <span class="text-orange-500 text-sm">Scheduled</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Agent training completed</p>
                                    <p class="text-gray-500 text-sm">Agent: Hindi Support Bot • 15 minutes ago</p>
                                </div>
                                <span class="text-purple-500 text-sm">Trained</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Active Voice Agents</h3>
                    <div class="space-y-4">
                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-online"></div>
                                    <h4 class="font-semibold text-gray-800">Sales Assistant</h4>
                                </div>
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">Hindi/English sales and lead generation assistant</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 47</span>
                                <span>Success Rate: 94%</span>
                            </div>
                        </div>

                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-busy"></div>
                                    <h4 class="font-semibold text-gray-800">Follow-up Assistant</h4>
                                </div>
                                <span class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Busy</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">Automated customer follow-up calls in Hindi</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 23</span>
                                <span>Success Rate: 87%</span>
                            </div>
                        </div>

                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-offline"></div>
                                    <h4 class="font-semibold text-gray-800">Customer Support</h4>
                                </div>
                                <span class="text-sm bg-gray-100 text-gray-800 px-2 py-1 rounded-full">Offline</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">24/7 customer support in Hindi</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 0</span>
                                <span>Success Rate: 98%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Agents Section -->
        <div id="agents" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('channels')" class="hover:text-blue-600 transition-colors" id="currentOrgBreadcrumb">
                        Organization
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="currentChannelName">Channel</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Voice Agents</span>
                </div>
            </div>

            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Voice Agents Management</h2>
                        <p class="text-gray-600 mt-2">Manage AI voice assistants for this channel</p>
                    </div>
                    <button onclick="addAgent()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Voice Agent
                    </button>
                </div>
            </div>

            <!-- Agent Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalChannelAgents">0</h3>
                    <p class="text-gray-600">Total Agents</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-play text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Active</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeChannelAgents">0</h3>
                    <p class="text-gray-600">Active Agents</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Combined</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgentContacts">0</h3>
                    <p class="text-gray-600">Total Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">This month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgentCalls">0</h3>
                    <p class="text-gray-600">Total Calls</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="agentSearchInput" placeholder="Search agents..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchAgents()">
                        </div>
                        <select id="agentStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterAgents()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="training">Training</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleAgentView('grid')" id="agentGridBtn" class="btn btn-secondary p-2">
                            <i class="fas fa-th"></i>
                        </button>
                        <button onclick="toggleAgentView('list')" id="agentListBtn" class="btn btn-secondary p-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Agents List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Channel Agents</h3>
                </div>

                <!-- Agents Grid -->
                <div id="agentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Agents will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="agentsEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Voice Agents Found</h3>
                    <p class="text-gray-600 mb-6">Create your first AI voice assistant for this channel</p>
                    <button onclick="addAgent()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Voice Agent
                    </button>
                </div>
            </div>
        </div>

        <div id="organizations" class="section p-6" style="display: none;">
            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Organizations Management</h2>
                        <p class="text-gray-600 mt-2">Manage your organizations and their channels</p>
                    </div>
                    <button onclick="addOrganization()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Organization
                    </button>
                </div>
            </div>

            <!-- Organizations Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+12% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalOrgs">0</h3>
                    <p class="text-gray-600">Total Organizations</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Active</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeOrgs">0</h3>
                    <p class="text-gray-600">Active Organizations</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-sitemap text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalChannels">0</h3>
                    <p class="text-gray-600">Total Channels</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Across all orgs</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgents">0</h3>
                    <p class="text-gray-600">Total Agents</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="orgSearchInput" placeholder="Search organizations..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchOrganizations()">
                        </div>
                        <select id="orgStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterOrganizations()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="trial">Trial</option>
                        </select>
                        <select id="orgTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterOrganizations()">
                            <option value="">All Types</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="retail">Retail Store</option>
                            <option value="technology">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="exportOrganizations()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                        <button onclick="refreshOrganizations()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Organizations List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Organizations</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleViewMode('grid')" id="gridViewBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleViewMode('list')" id="listViewBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="orgLoadingState" class="text-center py-8" style="display: none;">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Loading organizations...</p>
                </div>

                <!-- Organizations Grid/List Container -->
                <div id="organizationsContainer" class="space-y-4">
                    <!-- Organizations will be dynamically loaded here -->
                </div>

                <!-- Empty State -->
                <div id="orgEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-building text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Organizations Found</h3>
                    <p class="text-gray-600 mb-6">Get started by creating your first organization</p>
                    <button onclick="addOrganization()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Organization
                    </button>
                </div>
                <div id="organizationsList"></div>
            </div>
        </div>

        <!-- Organization Modal -->
        <div id="organizationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="if(event.target === this) closeOrganizationModal()">
            <div class="glassmorphism rounded-2xl p-8 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="orgModalTitle" class="text-2xl font-bold text-gray-800">Add New Organization</h3>
                    <button onclick="closeOrganizationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="organizationForm" onsubmit="submitOrganization(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name *</label>
                            <input type="text" id="orgName" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., ABC Enterprises">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                            <select id="orgType" required>
                              <option value="">Select Type</option>
                              <option value="healthcare">Healthcare</option>
                              <option value="retail">Retail</option>
                              <option value="finance">Finance</option>
                              <option value="education">Education</option>
                              <option value="general">General</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="orgStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="trial">Trial</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                            <input type="email" id="orgEmail" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="contact@organization.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                            <input type="tel" id="orgPhone" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+91 98765 43210">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="orgAddress" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Organization address"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="orgDescription" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Brief description of the organization"></textarea>
                        </div>
                    </div>

                    <div class="flex items-center justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeOrganizationModal()" class="btn btn-secondary px-6 py-3">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary px-6 py-3">
                            <i class="fas fa-save mr-2"></i>
                            Save Organization
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Channels Section -->
        <div id="channels" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="currentOrgName">Select Organization</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Channels</span>
                </div>
            </div>

            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Channels Management</h2>
                        <p class="text-gray-600 mt-2">Manage communication channels for your organization</p>
                    </div>
                    <button onclick="addChannel()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Channel
                    </button>
                </div>
            </div>

            <!-- Channel Types -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-blue-50 transition-colors" onclick="selectChannelType('inbound')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-phone-alt text-white"></i>
                        </div>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="inboundCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Inbound Calls</h3>
                    <p class="text-gray-600 text-sm">Handle incoming customer calls</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-green-50 transition-colors" onclick="selectChannelType('outbound')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full" id="outboundCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Outbound Calls</h3>
                    <p class="text-gray-600 text-sm">Make proactive customer calls</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-purple-50 transition-colors" onclick="selectChannelType('whatsapp')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fab fa-whatsapp text-white"></i>
                        </div>
                        <span class="text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded-full" id="whatsappCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">WhatsApp</h3>
                    <p class="text-gray-600 text-sm">WhatsApp messaging integration</p>
                </div>
            </div>

            <!-- Channels List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Active Channels</h3>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="channelSearchInput" placeholder="Search channels..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <select id="channelTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Types</option>
                            <option value="inbound">Inbound Calls</option>
                            <option value="outbound">Outbound Calls</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                </div>

                <!-- Channels Grid -->
                <div id="channelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Channels will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="channelsEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-satellite-dish text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Channels Found</h3>
                    <p class="text-gray-600 mb-6">Create your first communication channel</p>
                    <button onclick="addChannel()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Channel
                    </button>
                </div>
            </div>
        </div>

        <div id="contacts" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('channels')" class="hover:text-blue-600 transition-colors" id="contactOrgBreadcrumb">
                        Organization
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('agents')" class="hover:text-blue-600 transition-colors" id="contactChannelBreadcrumb">
                        Channel
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="contactAgentName">Agent</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Contacts</span>
                </div>
            </div>
            
            <!-- Contacts Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Contacts Management</h2>
                        <p class="text-gray-600 mt-2">Manage contacts for this voice agent</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="importContacts()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-upload mr-2"></i>
                            Import
                        </button>
                        <button onclick="addContact()" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>
                            Add Contact
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contact Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-blue-600 font-medium">+23</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalContactsCount">1,247</h3>
                    <p class="text-gray-600">Total Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-medium">87%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeContactsCount">1,084</h3>
                    <p class="text-gray-600">Active Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-purple-600 font-medium">Today</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="contactedTodayCount">156</h3>
                    <p class="text-gray-600">Contacted Today</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <span class="text-sm text-orange-600 font-medium">Avg</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="responseRateCount">94.2%</h3>
                    <p class="text-gray-600">Response Rate</p>
                </div>
            </div>

            <!-- Contact Filters and Search -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="contactSearchInput" placeholder="Search contacts..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchContacts()">
                        </div>
                        <select id="contactStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="blocked">Blocked</option>
                        </select>
                        <select id="contactAgentFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Agents</option>
                        </select>
                        <select id="contactLanguageFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Languages</option>
                            <option value="hindi">Hindi</option>
                            <option value="english">English</option>
                            <option value="hinglish">Hinglish</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="exportContacts()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                        <button onclick="bulkActions()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-edit mr-2"></i>
                            Bulk Edit
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contacts List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">All Contacts</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleContactView('grid')" id="contactGridBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleContactView('list')" id="contactListBtn" class="btn btn-primary px-3 py-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions Bar -->
                <div id="bulkActionsBar" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-blue-800 font-medium" id="selectedContactsCount">0 contacts selected</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="bulkEdit()" class="btn btn-secondary px-3 py-2 text-sm">
                                <i class="fas fa-edit mr-1"></i>
                                Edit
                            </button>
                            <button onclick="bulkDelete()" class="btn text-red-600 hover:text-red-800 px-3 py-2 text-sm">
                                <i class="fas fa-trash mr-1"></i>
                                Delete
                            </button>
                            <button onclick="clearContactSelection()" class="btn btn-secondary px-3 py-2 text-sm">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="contactsLoadingState" class="text-center py-8" style="display: none;">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Loading contacts...</p>
                </div>

                <!-- Contacts Container -->
                <div id="contactsContainer" class="space-y-4">
                    <!-- Contacts will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6">
                    <span class="text-sm text-gray-600" id="contactsPagination">Showing 1-50 of 1,247 contacts</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="previousContactsPage()" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3 py-2 bg-blue-100 text-blue-800 rounded-lg">1</span>
                        <button onclick="nextContactsPage()" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CRM Contacts Section -->
        <div id="crmContacts" class="section p-6" style="display: none;">
            <!-- CRM Contacts Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">CRM Contacts</h2>
                        <p class="text-gray-600 mt-2">Contacts synced from your CRM systems</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="syncAllCRMContacts()" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-sync mr-2"></i>
                            Sync All CRMs
                        </button>
                        <button onclick="exportCRMContacts()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- CRM Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fab fa-hubspot text-white"></i>
                        </div>
                        <span class="text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded-full" id="hubspotContactCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">HubSpot</h3>
                    <p class="text-gray-600 text-sm">Synced contacts</p>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fab fa-salesforce text-white"></i>
                        </div>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Salesforce</h3>
                    <p class="text-gray-600 text-sm">Coming soon</p>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full" id="totalCRMContacts">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Total Contacts</h3>
                    <p class="text-gray-600 text-sm">All CRM contacts</p>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-sync text-white"></i>
                        </div>
                        <span class="text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded-full" id="lastSyncTime">Never</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Last Sync</h3>
                    <p class="text-gray-600 text-sm">Sync status</p>
                </div>
            </div>

            <!-- CRM Contacts Table -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Contact List</h3>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <input type="text" id="crmContactSearch" placeholder="Search contacts..."
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-64">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="crmSourceFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Sources</option>
                            <option value="hubspot">HubSpot</option>
                            <option value="salesforce">Salesforce</option>
                        </select>
                    </div>
                </div>

                <!-- Contacts Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Name</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Company</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Source</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="crmContactsList">
                            <!-- CRM contacts will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="crmContactsEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-address-book text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No CRM Contacts Found</h3>
                    <p class="text-gray-600 mb-6">Connect your CRM and sync contacts to get started</p>
                    <button onclick="showSection('settings')" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-cog mr-2"></i>
                        Configure CRM
                    </button>
                </div>
            </div>
        </div>

        <div id="analytics" class="section p-6" style="display: none;">
            <!-- Analytics Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Advanced Analytics</h2>
                        <p class="text-gray-600 mt-2">Comprehensive insights into your voice agent performance</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="analyticsTimeRange" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="updateAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="exportAnalytics()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-medium">+15.3%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalCalls">2,847</h3>
                    <p class="text-gray-600">Total Calls</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-blue-600 font-medium">+8.7%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="successRate">94.2%</h3>
                    <p class="text-gray-600">Success Rate</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 94%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-sm text-purple-600 font-medium">-12.4%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="avgDuration">2:34</h3>
                    <p class="text-gray-600">Avg Call Duration</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <span class="text-sm text-orange-600 font-medium">+5.2%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="satisfaction">4.7/5</h3>
                    <p class="text-gray-600">Customer Rating</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 94%"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Call Volume Trends -->
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Call Volume Trends</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleChartType('callTrends', 'line')" class="text-sm text-blue-600 hover:text-blue-800">Line</button>
                            <span class="text-gray-300">|</span>
                            <button onclick="toggleChartType('callTrends', 'bar')" class="text-sm text-blue-600 hover:text-blue-800">Bar</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="callTrendsChart"></canvas>
                    </div>
                </div>

                <!-- Agent Performance -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Top Performing Agents</h3>
                    <div class="chart-container">
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>

                <!-- Language Distribution -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Language Distribution</h3>
                    <div class="chart-container">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>

                <!-- Call Outcomes -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Call Outcomes</h3>
                    <div class="chart-container">
                        <canvas id="outcomeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Real-time Activity -->
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Real-time Activity</h3>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-600">Live</span>
                        </div>
                    </div>
                    <div id="realtimeActivity" class="space-y-3 max-h-80 overflow-y-auto">
                        <!-- Real-time activities will be populated here -->
                    </div>
                </div>

                <!-- Performance Insights -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Insights</h3>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-arrow-up text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-green-800">Success Rate Improved</h4>
                                    <p class="text-green-600 text-sm">Up 8.7% compared to last month</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-language text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-800">Hindi Adoption Growing</h4>
                                    <p class="text-blue-600 text-sm">72% of calls now in Hindi/Hinglish</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-yellow-800">Peak Hours Identified</h4>
                                    <p class="text-yellow-600 text-sm">10 AM - 2 PM shows highest volume</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-purple-800">AI Accuracy Excellent</h4>
                                    <p class="text-purple-600 text-sm">97.3% intent recognition rate</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Reports -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Detailed Reports</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="reportSearch" placeholder="Search reports..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchReports()">
                        <button onclick="generateCustomReport()" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>
                            Custom Report
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Agent</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Total Calls</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Success Rate</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Avg Duration</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Rating</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="section p-6" style="display: none;">
            <!-- Settings Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
                        <p class="text-gray-600 mt-2">Configure your account, preferences, and platform settings</p>
                    </div>
                    <button onclick="saveAllSettings()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-save mr-2"></i>
                        Save All Changes
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Settings Navigation -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Settings Categories</h3>
                        <nav class="space-y-2">
                            <button onclick="showSettingsTab('account')" class="settings-nav-item active w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-user mr-3"></i>
                                Account Settings
                            </button>
                            <button onclick="showSettingsTab('notifications')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-bell mr-3"></i>
                                Notifications
                            </button>
                            <button onclick="showSettingsTab('api')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-code mr-3"></i>
                                API & Integrations
                            </button>
                            <button onclick="showSettingsTab('billing')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-credit-card mr-3"></i>
                                Billing & Usage
                            </button>
                            <button onclick="showSettingsTab('security')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-shield-alt mr-3"></i>
                                Security
                            </button>
                            <button onclick="showSettingsTab('advanced')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-cogs mr-3"></i>
                                Advanced
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="lg:col-span-3">
                    <!-- Account Settings -->
                    <div id="accountSettings" class="settings-content">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Account Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                    <input type="text" id="fullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="Dr. Rajesh Kumar" placeholder="Enter your full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                    <input type="email" id="emailAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="rajesh@abcenterprises.com" placeholder="Enter your email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" id="phoneNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="+91 98765 43210" placeholder="Enter your phone">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Zone</label>
                                    <select id="timeZone" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="Asia/Kolkata" selected>India Standard Time (IST)</option>
                                        <option value="UTC">Coordinated Universal Time (UTC)</option>
                                        <option value="America/New_York">Eastern Time (ET)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Language Preference</label>
                                    <select id="languagePref" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="en" selected>English</option>
                                        <option value="hi">हिंदी (Hindi)</option>
                                        <option value="hi-en">Hinglish</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" 
                                           value="Enterprise Admin" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Profile Picture</h3>
                            <div class="flex items-center space-x-6">
                                <div class="w-24 h-24 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                    <span class="text-white text-2xl font-bold">RK</span>
                                </div>
                                <div>
                                    <button onclick="uploadProfilePicture()" class="btn btn-secondary px-4 py-2 mb-2">
                                        <i class="fas fa-upload mr-2"></i>
                                        Upload New Picture
                                    </button>
                                    <p class="text-sm text-gray-600">JPG or PNG, max 5MB</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Settings -->
                    <div id="notificationsSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Email Notifications</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Call Summaries</h4>
                                        <p class="text-sm text-gray-600">Daily email with call statistics and summaries</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">System Alerts</h4>
                                        <p class="text-sm text-gray-600">Important system notifications and alerts</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Failed Calls</h4>
                                        <p class="text-sm text-gray-600">Notifications when calls fail or agents go offline</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Weekly Reports</h4>
                                        <p class="text-sm text-gray-600">Comprehensive weekly performance reports</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">SMS Notifications</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Urgent Notifications</h4>
                                        <p class="text-sm text-gray-600">Critical system failures and urgent issues</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Usage Limits</h4>
                                        <p class="text-sm text-gray-600">When approaching call or credit limits</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Settings -->
                    <div id="apiSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">API Keys</h3>
                            <div class="space-y-4">
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-800">Production API Key</h4>
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <code class="flex-1 p-2 bg-gray-100 rounded border font-mono text-sm">sk-prod-••••••••••••••••••••••••••••••••</code>
                                        <button onclick="copyApiKey('production')" class="btn btn-secondary px-3 py-2" title="Copy API Key">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="regenerateApiKey('production')" class="btn btn-secondary px-3 py-2" title="Regenerate API Key">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-800">Development API Key</h4>
                                        <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">Testing</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <code class="flex-1 p-2 bg-gray-100 rounded border font-mono text-sm">sk-dev-••••••••••••••••••••••••••••••••</code>
                                        <button onclick="copyApiKey('development')" class="btn btn-secondary px-3 py-2" title="Copy API Key">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="regenerateApiKey('development')" class="btn btn-secondary px-3 py-2" title="Regenerate API Key">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="generateNewApiKey()" class="btn btn-primary px-4 py-2 mt-4">
                                <i class="fas fa-plus mr-2"></i>
                                Generate New API Key
                            </button>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Webhook Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Webhook URL</label>
                                    <input type="url" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           placeholder="https://your-domain.com/webhook" value="https://abcenterprises.com/webhook">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Events to Subscribe</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2" checked>
                                            Call Started
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2" checked>
                                            Call Ended
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2">
                                            Agent Created
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2">
                                            Contact Added
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CRM Integrations -->
                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">CRM Integrations</h3>
                            <div class="space-y-4">
                                <!-- HubSpot Integration -->
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                                                <i class="fab fa-hubspot text-white text-lg"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-gray-800">HubSpot</h4>
                                                <p class="text-sm text-gray-600">Sync contacts and deals</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span id="hubspotStatus" class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">Not Connected</span>
                                            <button id="hubspotConnectBtn" onclick="connectHubSpot()" class="btn btn-primary px-4 py-2">
                                                Connect
                                            </button>
                                        </div>
                                    </div>
                                    <div id="hubspotConnected" class="hidden">
                                        <div class="text-sm text-gray-600 mb-3">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                            Connected successfully
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="syncHubSpotContacts()" class="btn btn-primary px-3 py-1 text-sm">
                                                <i class="fas fa-sync mr-1"></i>
                                                Sync Contacts
                                            </button>
                                            <button onclick="viewHubSpotContacts()" class="btn btn-secondary px-3 py-1 text-sm">
                                                <i class="fas fa-users mr-1"></i>
                                                View Contacts
                                            </button>
                                            <button onclick="disconnectHubSpot()" class="btn btn-secondary px-3 py-1 text-sm">
                                                Disconnect
                                            </button>
                                        </div>
                                        <div id="syncStatus" class="mt-2 text-sm hidden"></div>
                                    </div>
                                </div>

                                <!-- Salesforce Integration -->
                                <div class="p-4 border border-gray-200 rounded-lg opacity-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                                <i class="fab fa-salesforce text-white text-lg"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-gray-800">Salesforce</h4>
                                                <p class="text-sm text-gray-600">Sync leads and opportunities</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">Coming Soon</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pipedrive Integration -->
                                <div class="p-4 border border-gray-200 rounded-lg opacity-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-pipe text-white text-lg"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-gray-800">Pipedrive</h4>
                                                <p class="text-sm text-gray-600">Sync deals and activities</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">Coming Soon</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Settings -->
                    <div id="billingSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Current Plan & Usage</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Current Plan</h4>
                                    <p class="text-2xl font-bold text-blue-600">Premium</p>
                                    <p class="text-sm text-gray-600">₹2,999/month</p>
                                </div>
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Calls This Month</h4>
                                    <p class="text-2xl font-bold text-green-600">2,847</p>
                                    <p class="text-sm text-gray-600">of 5,000 included</p>
                                </div>
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Next Billing</h4>
                                    <p class="text-2xl font-bold text-orange-600">Aug 15</p>
                                    <p class="text-sm text-gray-600">₹2,999</p>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Payment Methods</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-credit-card text-blue-500 text-xl"></i>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">•••• •••• •••• 4532</h4>
                                            <p class="text-sm text-gray-600">Expires 12/26</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Primary</span>
                                        <button onclick="editPaymentMethod('primary')" class="text-gray-500 hover:text-gray-700" title="Edit Payment Method">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="addPaymentMethod()" class="btn btn-primary px-4 py-2 mt-4">
                                <i class="fas fa-plus mr-2"></i>
                                Add Payment Method
                            </button>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div id="securitySettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Password & Authentication</h3>
                            <div class="space-y-4">
                                <button onclick="showChangePasswordModal()" class="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Change Password</h4>
                                            <p class="text-sm text-gray-600">Last changed 30 days ago</p>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </button>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Two-Factor Authentication</h4>
                                        <p class="text-sm text-gray-600">Add an extra layer of security</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Session Management</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Current Session</h4>
                                        <p class="text-sm text-gray-600">Chrome on Windows • 192.168.1.100</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>
                                </div>
                            </div>
                            <button onclick="signOutAllSessions()" class="btn text-red-600 hover:text-red-800 px-4 py-2 mt-4">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                Sign Out All Sessions
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div id="advancedSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Data & Privacy</h3>
                            <div class="space-y-4">
                                <button onclick="exportAccountData()" class="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Export Data</h4>
                                            <p class="text-sm text-gray-600">Download all your account data</p>
                                        </div>
                                        <i class="fas fa-download text-gray-400"></i>
                                    </div>
                                </button>
                                <button onclick="showDeleteAccountModal()" class="w-full text-left p-4 border border-red-200 rounded-lg hover:bg-red-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-red-800">Delete Account</h4>
                                            <p class="text-sm text-red-600">Permanently delete your account and all data</p>
                                        </div>
                                        <i class="fas fa-trash text-red-400"></i>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">System Preferences</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Analytics Tracking</h4>
                                        <p class="text-sm text-gray-600">Help improve the platform with usage analytics</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Beta Features</h4>
                                        <p class="text-sm text-gray-600">Access experimental features before they're released</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phone Numbers Section -->
        <div id="phone-numbers" class="section p-6" style="display: none;">
            <!-- Phone Numbers Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Phone Number Management</h2>
                        <p class="text-gray-600 mt-2">Search, purchase, and manage phone numbers from multiple providers</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="refreshPhoneNumbers()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                        <button onclick="showPhoneSearchModal()" class="btn btn-primary px-6 py-3">
                            <i class="fas fa-search mr-2"></i>
                            Search Numbers
                        </button>
                    </div>
                </div>
            </div>

            <!-- Phone Numbers Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Owned Numbers</p>
                            <p class="text-2xl font-bold text-gray-800" id="ownedNumbersCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Monthly Cost</p>
                            <p class="text-2xl font-bold text-gray-800" id="monthlyPhoneCost">$0.00</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Active Providers</p>
                            <p class="text-2xl font-bold text-gray-800" id="activeProvidersCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-network-wired text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Countries</p>
                            <p class="text-2xl font-bold text-gray-800" id="countriesCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-cyan-500 to-cyan-600 flex items-center justify-center">
                            <i class="fas fa-globe text-white"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Owned Phone Numbers -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Your Phone Numbers</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="phoneNumberSearch" placeholder="Search phone numbers..."
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="filterPhoneNumbers()">
                        <select id="providerFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPhoneNumbers()">
                            <option value="">All Providers</option>
                            <option value="twilio">Twilio</option>
                            <option value="telnyx">Telnyx</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone Number</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Provider</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Country</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Capabilities</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Monthly Cost</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ownedPhoneNumbersTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                                    <p>No phone numbers found. Click "Search Numbers" to get started.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile menu button -->
    <button onclick="toggleMobileMenu()" id="mobileMenuBtn" class="fixed top-4 left-4 z-50 p-3 glassmorphism rounded-full lg:hidden">
        <i class="fas fa-bars text-gray-700"></i>
    </button>

    <!-- Phone Number Search Modal -->
    <div id="phoneSearchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glassmorphism rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Search Available Phone Numbers</h3>
                    <button onclick="closePhoneSearchModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Search Form -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <select id="searchCountry" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="US">United States</option>
                            <option value="IN">India</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Area Code</label>
                        <input type="text" id="searchAreaCode" placeholder="e.g., 555"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pattern</label>
                        <input type="text" id="searchPattern" placeholder="e.g., *123*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Capabilities</label>
                        <select id="searchCapabilities" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All</option>
                            <option value="voice">Voice Only</option>
                            <option value="sms">SMS Only</option>
                            <option value="voice,sms">Voice + SMS</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="searchTwilio" checked class="mr-2">
                            <span class="text-sm text-gray-700">Twilio</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="searchTelnyx" checked class="mr-2">
                            <span class="text-sm text-gray-700">Telnyx</span>
                        </label>
                    </div>
                    <button onclick="searchPhoneNumbers()" class="btn btn-primary px-6 py-2">
                        <i class="fas fa-search mr-2"></i>
                        Search Numbers
                    </button>
                </div>

                <!-- Search Results -->
                <div id="phoneSearchResults" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">Available Numbers</h4>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">Sort by:</span>
                            <select id="sortResults" class="px-3 py-1 border border-gray-300 rounded text-sm" onchange="sortSearchResults()">
                                <option value="price">Price (Low to High)</option>
                                <option value="provider">Provider</option>
                                <option value="number">Phone Number</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone Number</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Provider</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Capabilities</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Monthly Cost</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Setup Cost</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Action</th>
                                </tr>
                            </thead>
                            <tbody id="phoneSearchResultsTable">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="phoneSearchLoading" class="hidden text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Searching available phone numbers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Number Purchase Confirmation Modal -->
    <div id="phonePurchaseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glassmorphism rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Confirm Purchase</h3>
                    <button onclick="closePurchaseModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div id="purchaseDetails" class="mb-6">
                    <!-- Purchase details will be populated here -->
                </div>

                <div class="flex items-center justify-end space-x-3">
                    <button onclick="closePurchaseModal()" class="btn btn-secondary px-4 py-2">
                        Cancel
                    </button>
                    <button onclick="confirmPhonePurchase()" class="btn btn-primary px-6 py-2">
                        <i class="fas fa-credit-card mr-2"></i>
                        Purchase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication state
        let currentUser = null;
        let authToken = null;

        // Initialize Authentication
        async function initializeAuth() {
            try {
                // Check authentication
                authToken = localStorage.getItem('auth_token') || getCookie('auth_token');

                if (!authToken) {
                    console.log('❌ No auth token found, redirecting to login');
                    window.location.href = '/login';
                    return false;
                }

                // Verify token with server
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('✅ User authenticated:', currentUser.user.email);
                    updateUserInterface();
                    return true;
                } else {
                    console.log('❌ Token invalid, redirecting to login');
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return false;
                }

            } catch (error) {
                console.error('❌ Authentication error:', error);
                window.location.href = '/login';
                return false;
            }
        }

        // Update UI with user information
        function updateUserInterface() {
            if (currentUser && currentUser.user) {
                const user = currentUser.user;

                // Update user name in header
                const userNameElements = document.querySelectorAll('.user-name');
                userNameElements.forEach(el => {
                    el.textContent = user.name || user.email;
                });

                // Update user email
                const userEmailElements = document.querySelectorAll('.user-email');
                userEmailElements.forEach(el => {
                    el.textContent = user.email;
                });

                // Update user role badge
                const userRoleElements = document.querySelectorAll('.user-role');
                userRoleElements.forEach(el => {
                    el.textContent = user.role.toUpperCase();
                    el.className = `user-role px-2 py-1 rounded text-xs font-medium ${getRoleColor(user.role)}`;
                });

                // Show/hide admin features based on role
                if (user.role === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                } else {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                }
            }
        }

        // Get role color class
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'manager': return 'bg-blue-100 text-blue-800';
                case 'user': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('auth_token');
            window.location.href = '/login';
        }

        // API helper function with authentication
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                // Token expired or invalid
                localStorage.removeItem('auth_token');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API request failed');
            }

            return response.json();
        }

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                // Fetch dashboard statistics from new API endpoint
                const statsResponse = await apiRequest('/api/dashboard/stats');
                console.log('Dashboard stats:', statsResponse);

                // Update all dashboard metrics with real data
                updateDashboardMetrics(statsResponse);

                // Fetch and display organizations
                const organizations = await fetchUserOrganizations();
                console.log('Organizations from fetchUserOrganizations:', organizations);
                displayOrganizations(organizations);

                // Store data globally
                window.dashboardData = {
                    organizations,
                    stats: statsResponse
                };

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                showError('Failed to load dashboard data');

                // Fallback to showing empty state
                updateDashboardMetrics({
                    organizations: 0,
                    channels: 0,
                    voice_agents: 0,
                    contacts: 0,
                    phone_numbers: 0,
                    inbound_channels: 0,
                    outbound_channels: 0,
                    whatsapp_channels: 0,
                    active_contacts: 0,
                    contacted_today: 0,
                    response_rate: 0,
                    countries: 0,
                    active_providers: 0
                });
            }
        }

        // Update dashboard metrics with real data
        function updateDashboardMetrics(stats) {
            // Main dashboard cards
            document.getElementById('orgCount').textContent = stats.organizations || 0;
            document.getElementById('channelCount').textContent = stats.channels || 0;
            document.getElementById('agentCount').textContent = stats.voice_agents || 0;
            document.getElementById('contactCount').textContent = stats.contacts || 0;

            // Navigation counts
            document.getElementById('orgNavCount').textContent = stats.organizations || 0;
            document.getElementById('channelNavCount').textContent = stats.channels || 0;
            document.getElementById('agentNavCount').textContent = stats.voice_agents || 0;
            document.getElementById('contactNavCount').textContent = stats.contacts || 0;
            document.getElementById('phoneNavCount').textContent = stats.phone_numbers || 0;

            // Channel type counts
            document.getElementById('inboundCount').textContent = stats.inbound_channels || 0;
            document.getElementById('outboundCount').textContent = stats.outbound_channels || 0;
            document.getElementById('whatsappCount').textContent = stats.whatsapp_channels || 0;

            // Contact statistics
            document.getElementById('totalContactsCount').textContent = stats.contacts || 0;
            document.getElementById('activeContactsCount').textContent = stats.active_contacts || 0;
            document.getElementById('contactedTodayCount').textContent = stats.contacted_today || 0;
            document.getElementById('responseRateCount').textContent = `${stats.response_rate || 0}%`;

            // Phone number statistics
            document.getElementById('ownedNumbersCount').textContent = stats.phone_numbers || 0;
            document.getElementById('activeProvidersCount').textContent = stats.active_providers || 0;
            document.getElementById('countriesCount').textContent = stats.countries || 0;
        }

        // Show error message to user
        function showError(message) {
            console.error(message);

            // Create or update error notification
            let errorDiv = document.getElementById('errorNotification');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'errorNotification';
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                document.body.appendChild(errorDiv);
            }

            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }, 5000);
        }

        // Update active agents display
        function updateActiveAgents(agents) {
            const container = document.querySelector('.space-y-4');
            if (!agents || agents.length === 0) return;
            
            const agentCards = agents.slice(0, 3).map(agent => {
                const status = agent.is_active ? 'online' : 'offline';
                const statusText = agent.is_active ? 'Active' : 'Offline';
                const statusClass = agent.is_active ? 'green' : 'gray';
                
                return `
                    <div class="agent-card">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="status-indicator status-${status}"></div>
                                <h4 class="font-semibold text-gray-800">${agent.name || 'Unnamed Agent'}</h4>
                            </div>
                            <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full">${statusText}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${agent.description || 'No description'}</p>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Channel: ${agent.channel_name || 'Unknown'}</span>
                            <span>Created: ${new Date(agent.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = agentCards;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AgentSDR Modern Dashboard loaded successfully!');

            // Initialize authentication first
            const isAuthenticated = await initializeAuth();
            if (!isAuthenticated) {
                return; // Will redirect to login
            }

            console.log('✅ Authentication successful, loading dashboard data...');

            // Fetch real data after authentication
            fetchDashboardData();
            
            // Force load organizations data
            setTimeout(() => {
                console.log('Force loading organizations data...');
                if (typeof loadOrganizations === 'function') {
                    loadOrganizations();
                }
            }, 1000);

            // Initialize charts
            initializeCharts();
            
            // Setup responsive design
            setupResponsiveDesign();
            
            // Animate metrics on load
            animateMetrics();
            
            // Refresh data every 30 seconds
            setInterval(fetchDashboardData, 30000);
        });

        // Global state for hierarchical navigation
        let currentOrganization = null;
        let currentChannel = null;
        let currentAgent = null;

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).style.display = 'block';
            
            // Add active class to clicked nav item
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }
            
            // Update breadcrumb and navigation visibility
            updateNavigationState(sectionName);
            
            // Load data for specific sections
            if (sectionName === 'organizations') {
                loadOrganizations();
            } else if (sectionName === 'channels') {
                loadChannels();
            } else if (sectionName === 'agents') {
                loadAgents();
            } else if (sectionName === 'contacts') {
                loadContacts();
            } else if (sectionName === 'phone-numbers') {
                loadPhoneNumbers();
            } else if (sectionName === 'settings') {
                // Initialize settings tabs when settings section is shown
                setTimeout(() => {
                    initializeSettings();
                }, 100);
            }
        }

        // Update navigation state based on current section
        function updateNavigationState(sectionName) {
            const breadcrumb = document.getElementById('currentLevel');
            const breadcrumbArrow = document.getElementById('breadcrumbArrow');
            const currentItem = document.getElementById('currentItem');
            const channelsNav = document.getElementById('channelsNav');
            const agentsNav = document.getElementById('agentsNav');
            const contactsNav = document.getElementById('contactsNav');
            
            // Reset visibility
            channelsNav.style.display = 'none';
            agentsNav.style.display = 'none';
            contactsNav.style.display = 'none';
            breadcrumbArrow.style.display = 'none';
            currentItem.style.display = 'none';
            
            switch(sectionName) {
                case 'dashboard':
                    breadcrumb.textContent = 'Enterprise Dashboard';
                    break;
                case 'organizations':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = 'Organizations';
                    break;
                case 'channels':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentOrganization ? `${currentOrganization.name} → Channels` : 'Channels';
                    channelsNav.style.display = 'block';
                    break;
                case 'agents':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentChannel ? `${currentOrganization?.name} → ${currentChannel.name} → Agents` : 'Voice Agents';
                    channelsNav.style.display = 'block';
                    agentsNav.style.display = 'block';
                    break;
                case 'contacts':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentAgent ? `${currentOrganization?.name} → ${currentChannel?.name} → ${currentAgent.name} → Contacts` : 'Contacts';
                    channelsNav.style.display = 'block';
                    agentsNav.style.display = 'block';
                    contactsNav.style.display = 'block';
                    break;
                default:
                    breadcrumb.textContent = 'Enterprise';
            }
        }

        // Navigation functions for hierarchy
        function viewOrganization(orgId) {
            console.log('viewOrganization called with ID:', orgId);
            console.log('Available organizations:', window.lastOrganizations);
            
            const org = window.lastOrganizations?.find(o => o.id == orgId || o.id === orgId);
            if (!org) { 
                console.error('Organization not found with ID:', orgId);
                console.error('Available org IDs:', window.lastOrganizations?.map(o => o.id));
                alert("Organization not found."); 
                return; 
            }
            
            console.log('Found organization for viewing:', org);
            
            showOrganizationModal();
            document.getElementById('orgModalTitle').textContent = 'View Organization Details';
            
            // Longer delay to ensure modal is fully loaded and form is cleared
            setTimeout(() => {
                console.log('About to fill form for viewing with data:', org);
                fillOrganizationForm(org, true); // true = read-only mode
                window.currentEditingOrg = null; // Not editing
                console.log('Form should now be filled in view mode');
            }, 200);
        }

        // ✅ EDIT FUNCTION - Based on Supabase Schema
        function editOrganization(orgId) {
            console.log('🟢 Edit Organization called with ID:', orgId);
            
            // Find organization from global data
            const org = window.lastOrganizations?.find(o => o.id === orgId);
            if (!org) {
                console.error('❌ Organization not found');
                alert('Organization not found!');
                return;
            }
            
            console.log('✅ Found organization:', org);
            
            // Show modal
            const modal = document.getElementById('organizationModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            
            // Set title for edit mode
            document.getElementById('orgModalTitle').textContent = '✏️ Edit Organization';
            
            // Wait a moment for modal to render, then fill form
            setTimeout(() => {
                console.log('Filling form for edit mode...');
                fillOrganizationForm(org, false); // false = editable mode
                window.currentEditingOrg = org; // Set editing context
                
                // Update save button text
                const submitBtn = document.querySelector('#organizationForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Save Changes';
                }
                
                // Set cancel button
                const cancelBtn = document.querySelector('#organizationModal button[onclick="closeOrganizationModal()"]');
                if (cancelBtn) {
                    cancelBtn.textContent = 'Cancel';
                }
                
                console.log('Form filling completed');
            }, 300);
            
            // Store for editing
            window.currentEditingOrg = orgData;
        }

        function closeOrganizationModal() {
            console.log('🔴 Closing organization modal');
            hideOrganizationModal();
            window.currentEditingOrg = null;
            
            // Reset form
            const form = document.getElementById('organizationForm');
            if (form) {
                form.reset();
            }
            
            // Re-enable all form elements
            const formElements = document.querySelectorAll('#organizationForm input, #organizationForm select, #organizationForm textarea');
            formElements.forEach(el => {
                el.disabled = false;
                el.style.backgroundColor = '';
                el.style.cursor = '';
                el.style.color = '';
            });
        }

        async function deleteOrganization(orgId) {
            if (!confirm("Are you sure you want to delete this organization? This action cannot be undone.")) return;
            
            try {
                const response = await apiRequest(`/api/organizations/${orgId}`, {
                    method: 'DELETE'
                });
                
                if (response.success) {
                    alert("Organization deleted successfully!");
                    // Refresh the organizations list
                    if (typeof loadOrganizations === 'function') {
                        loadOrganizations();
                    } else {
                        fetchDashboardData();
                    }
                } else {
                    alert("Error deleting organization: " + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting organization:', error);
                alert("Error deleting organization: " + error.message);
            }
        }

        function selectChannelType(type) {
            // Filter channels by type and show channels of that type
            const channels = currentOrganization?.channels?.filter(c => c.type === type) || [];
            displayChannelsByType(type, channels);
        }

        function viewChannel(channelId) {
            const channel = currentOrganization?.channels?.find(c => c.id === channelId);
            if (channel) {
                currentChannel = channel;
                showSection('agents');
            }
        }

        function viewAgent(agentId) {
            const agent = currentChannel?.agents?.find(a => a.id === agentId);
            if (agent) {
                currentAgent = agent;
                showSection('contacts');
            }
        }

        // Channel management functions
        async function loadChannels() {
            if (!currentOrganization) {
                showSection('organizations');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/organizations/${currentOrganization.id}/channels`);
                const channels = response.channels || [];
                
                // Update channel counts
                const inboundCount = channels.filter(c => c.type === 'inbound').length;
                const outboundCount = channels.filter(c => c.type === 'outbound').length;
                const whatsappCount = channels.filter(c => c.type === 'whatsapp').length;
                
                document.getElementById('inboundCount').textContent = inboundCount;
                document.getElementById('outboundCount').textContent = outboundCount;
                document.getElementById('whatsappCount').textContent = whatsappCount;
                
                displayChannels(channels);
            } catch (error) {
                console.error('Error loading channels:', error);
                showChannelsEmptyState();
            }
        }

        function displayChannels(channels) {
            const container = document.getElementById('channelsList');
            const emptyState = document.getElementById('channelsEmptyState');
            
            if (channels.length === 0) {
                showChannelsEmptyState();
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            container.innerHTML = channels.map(channel => createChannelCard(channel)).join('');
        }

        function createChannelCard(channel) {
            const typeIcons = {
                inbound: 'phone-alt',
                outbound: 'phone',
                whatsapp: 'fab fa-whatsapp'
            };
            const typeColors = {
                inbound: 'blue',
                outbound: 'green',
                whatsapp: 'purple'
            };
            
            const icon = typeIcons[channel.type] || 'satellite-dish';
            const color = typeColors[channel.type] || 'gray';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewChannel('${channel.id}')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-${color}-500 to-${color}-600 flex items-center justify-center">
                            <i class="fas ${icon.startsWith('fab') ? icon : 'fa-' + icon} text-white"></i>
                        </div>
                        <span class="text-sm bg-${color}-100 text-${color}-800 px-2 py-1 rounded-full">${channel.status}</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${channel.name}</h3>
                    <p class="text-gray-600 text-sm mb-4">${channel.description || 'No description available'}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span><i class="fas fa-robot mr-1"></i>${(channel.agents?.length || 0)} Agents</span>
                        <span><i class="fas fa-users mr-1"></i>${getChannelContactCount(channel)} Contacts</span>
                    </div>
                </div>
            `;
        }

        function getChannelContactCount(channel) {
            let count = 0;
            if (channel.agents) {
                channel.agents.forEach(agent => {
                    count += agent.contacts?.length || 0;
                });
            }
            return count;
        }

        function showChannelsEmptyState() {
            document.getElementById('channelsList').style.display = 'none';
            document.getElementById('channelsEmptyState').style.display = 'block';
        }

        function addChannel() {
            // Implementation for adding new channel
            console.log('Add channel for organization:', currentOrganization?.name);
        }

        // Agent management functions
        async function loadAgents() {
            if (!currentChannel) {
                showSection('channels');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/channels/${currentChannel.id}/agents`);
                const agents = response.agents || [];
                displayAgents(agents);
            } catch (error) {
                console.error('Error loading agents:', error);
                showAgentsEmptyState();
            }
        }

        function displayAgents(agents) {
            const container = document.getElementById('agentsList');
            const emptyState = document.getElementById('agentsEmptyState');
            
            if (agents.length === 0) {
                showAgentsEmptyState();
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Update breadcrumb
            if (currentOrganization && currentChannel) {
                document.getElementById('currentOrgBreadcrumb').textContent = currentOrganization.name;
                document.getElementById('currentChannelName').textContent = currentChannel.name;
            }
            
            // Update agent stats
            const activeAgents = agents.filter(a => a.status === 'active').length;
            let totalContacts = 0;
            let totalCalls = 0;
            
            agents.forEach(agent => {
                totalContacts += agent.contacts?.length || 0;
                totalCalls += agent.calls_count || 0;
            });
            
            document.getElementById('totalChannelAgents').textContent = agents.length;
            document.getElementById('activeChannelAgents').textContent = activeAgents;
            document.getElementById('totalAgentContacts').textContent = totalContacts;
            document.getElementById('totalAgentCalls').textContent = totalCalls;
            
            container.innerHTML = agents.map(agent => createAgentCard(agent)).join('');
        }

        function createAgentCard(agent) {
            const statusClass = agent.status === 'active' ? 'green' : agent.status === 'training' ? 'yellow' : 'red';
            const statusIcon = agent.status === 'active' ? 'play' : agent.status === 'training' ? 'clock' : 'pause';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewAgent('${agent.id}')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full flex items-center">
                            <i class="fas fa-${statusIcon} mr-1"></i>${agent.status}
                        </span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${agent.name}</h3>
                    <p class="text-gray-600 text-sm mb-4">${agent.description || 'No description available'}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-users mr-1"></i>Contacts</span>
                            <span class="font-medium">${agent.contacts?.length || 0}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-phone mr-1"></i>Calls (Month)</span>
                            <span class="font-medium">${agent.calls_count || 0}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-percentage mr-1"></i>Success Rate</span>
                            <span class="font-medium">${agent.success_rate || 0}%</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            Created: ${new Date(agent.created_at).toLocaleDateString()}
                        </span>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); editAgent('${agent.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteAgent('${agent.id}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAgentsEmptyState() {
            document.getElementById('agentsList').style.display = 'none';
            document.getElementById('agentsEmptyState').style.display = 'block';
        }

        function addAgent() {
            // Implementation for adding new agent
            console.log('Add agent for channel:', currentChannel?.name);
        }

        function editAgent(agentId) {
            console.log('Edit agent:', agentId);
        }

        function deleteAgent(agentId) {
            console.log('Delete agent:', agentId);
        }

        function searchAgents() {
            // Implementation for searching agents
            console.log('Search agents');
        }

        function filterAgents() {
            // Implementation for filtering agents
            console.log('Filter agents');
        }

        function toggleAgentView(viewType) {
            // Implementation for toggling view
            console.log('Toggle agent view:', viewType);
        }

        // Contact management functions
        async function loadContacts() {
            if (!currentAgent) {
                showSection('agents');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/agents/${currentAgent.id}/contacts`);
                const contacts = response.contacts || [];
                displayContacts(contacts);
            } catch (error) {
                console.error('Error loading contacts:', error);
                showContactsEmptyState();
            }
        }

        function displayContacts(contacts) {
            const container = document.querySelector('#contacts .space-y-4'); // Main contacts container
            const emptyState = document.getElementById('contactsEmptyState');
            
            if (contacts.length === 0) {
                showContactsEmptyState();
                return;
            }
            
            if (container) {
                container.style.display = 'block';
            }
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Update breadcrumb
            if (currentOrganization && currentChannel && currentAgent) {
                document.getElementById('contactOrgBreadcrumb').textContent = currentOrganization.name;
                document.getElementById('contactChannelBreadcrumb').textContent = currentChannel.name;
                document.getElementById('contactAgentName').textContent = currentAgent.name;
            }
            
            // Update contact stats
            const activeContacts = contacts.filter(c => c.status === 'active').length;
            const contactedToday = contacts.filter(c => {
                const today = new Date().toDateString();
                return new Date(c.last_contacted).toDateString() === today;
            }).length;
            
            document.getElementById('totalContactsCount').textContent = contacts.length;
            document.getElementById('activeContactsCount').textContent = activeContacts;
            document.getElementById('contactedTodayCount').textContent = contactedToday;
            
            // Calculate average response rate
            const responsesCount = contacts.filter(c => c.response_rate).length;
            const avgResponseRate = responsesCount > 0 ? 
                contacts.reduce((sum, c) => sum + (c.response_rate || 0), 0) / responsesCount : 0;
            document.getElementById('responseRateCount').textContent = avgResponseRate.toFixed(1) + '%';
            
            // Display contacts (if container exists)
            if (container) {
                container.innerHTML = contacts.map(contact => createContactCard(contact)).join('');
            }
        }

        function createContactCard(contact) {
            const statusClass = contact.status === 'active' ? 'green' : contact.status === 'blocked' ? 'red' : 'gray';
            const lastContacted = contact.last_contacted ? 
                new Date(contact.last_contacted).toLocaleDateString() : 'Never';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                <span class="text-white font-bold">${contact.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">${contact.name}</h3>
                                <p class="text-sm text-gray-500">${contact.phone}</p>
                            </div>
                        </div>
                        <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full">
                            ${contact.status}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${contact.email ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-envelope mr-2"></i>${contact.email}
                        </div>` : ''}
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-calendar mr-2"></i>Last contacted: ${lastContacted}
                        </div>
                        ${contact.language ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-language mr-2"></i>${contact.language}
                        </div>` : ''}
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            Added: ${new Date(contact.created_at).toLocaleDateString()}
                        </span>
                        <div class="flex items-center space-x-2">
                            <button onclick="editContact('${contact.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="callContact('${contact.id}')" 
                                    class="text-green-600 hover:text-green-800" title="Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button onclick="deleteContact('${contact.id}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showContactsEmptyState() {
            const container = document.querySelector('#contacts .space-y-4');
            if (container) {
                container.style.display = 'none';
            }
            
            // Could add a specific empty state display here
            console.log('Show contacts empty state for agent:', currentAgent?.name);
        }

        function addContact() {
            console.log('Add contact for agent:', currentAgent?.name);
        }

        function editContact(contactId) {
            console.log('Edit contact:', contactId);
        }

        function deleteContact(contactId) {
            console.log('Delete contact:', contactId);
        }

        function callContact(contactId) {
            console.log('Call contact:', contactId);
        }

        function importContacts() {
            console.log('Import contacts for agent:', currentAgent?.name);
        }

        // Initialize Charts
        function initializeCharts() {
            // Call Volume Chart
            const callVolumeCtx = document.getElementById('callVolumeChart').getContext('2d');
            new Chart(callVolumeCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Successful Calls',
                        data: [650, 789, 845, 923, 1102, 1247],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Failed Calls',
                        data: [45, 52, 38, 67, 73, 89],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Failed', 'Pending'],
                    datasets: [{
                        data: [85, 10, 5],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Animate metrics on load
        function animateMetrics() {
            const metrics = [
                { id: 'orgCount', target: 2 },
                { id: 'agentCount', target: 5 },
                { id: 'contactCount', target: 124 }
            ];

            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                let current = 0;
                const increment = metric.target / 50;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= metric.target) {
                        current = metric.target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 30);
            });
        }

        // Theme toggle
        function toggleTheme() {
            const toggle = document.querySelector('.theme-toggle');
            toggle.classList.toggle('dark');
            document.body.classList.toggle('dark-mode');
        }

        // Mobile responsiveness
        function setupResponsiveDesign() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Close sidebar on mobile when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 1024 && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.add('-translate-x-full');
                }
            });
        }

        // Show calls modal
        function showCallsModal() {
            alert('Call campaign feature coming soon! This will allow you to start automated calling campaigns with your voice agents.');
        }

        // Sign out
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                logout();
            }
        }

        // Organization management variables
        let allOrganizations = [];
        let filteredOrganizations = [];
        let currentViewMode = 'list';
        let currentEditingOrg = null;

        // Load organizations data
        async function loadOrganizations() {
            try {
                document.getElementById('orgLoadingState').style.display = 'block';
                document.getElementById('organizationsContainer').style.display = 'none';
                
                const response = await apiRequest('/api/organizations');
                allOrganizations = response.data || [];
                filteredOrganizations = [...allOrganizations];
                
                console.log('Loaded organizations in loadOrganizations:', allOrganizations);
                
                updateOrganizationStats();
                displayOrganizations(allOrganizations);
                
            } catch (error) {
                console.error('Error loading organizations:', error);
                showOrgEmptyState();
            } finally {
                document.getElementById('orgLoadingState').style.display = 'none';
            }
        }

        // Update organization statistics
        function updateOrganizationStats() {
            const total = allOrganizations.length;
            const active = allOrganizations.filter(org => org.status === 'active').length;
            
            // Count channels and agents
            let totalChannels = 0;
            let totalAgents = 0;
            allOrganizations.forEach(org => {
                totalChannels += org.channels?.length || 0;
                if (org.channels) {
                    org.channels.forEach(channel => {
                        totalAgents += channel.agents?.length || 0;
                    });
                }
            });
            
            document.getElementById('totalOrgs').textContent = total;
            document.getElementById('activeOrgs').textContent = active;
            document.getElementById('totalChannels').textContent = totalChannels;
            document.getElementById('totalAgents').textContent = totalAgents;
        }

        // Display organizations
        function displayOrganizations(organizations) {
            console.log('displayOrganizations called with:', organizations);
            
            // We have real API data, no need for dummy data
            if (!organizations || organizations.length === 0) {
                console.log('No organizations found from API');
                return;
            }
            
            window.lastOrganizations = organizations; // Yeh line zaroori hai!
            console.log('Stored organizations in window.lastOrganizations:', window.lastOrganizations);
            const container = document.getElementById('organizationsList');
            if (!container) return;

            // Toggle empty state visibility
            const emptyState = document.getElementById('orgEmptyState');
            if (emptyState) {
                if (!organizations || organizations.length === 0) {
                    emptyState.style.display = 'block';
            } else {
                    emptyState.style.display = 'none';
                }
            }

            if (!organizations || organizations.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div style="overflow-x: auto; max-width: 100%;">
                    <div style="min-width: 1100px; max-height: 400px; overflow-y: auto;">
                        <div style="display: flex; font-weight: bold; background: #f3f4f6; border-bottom: 2px solid #ddd; padding: 10px 0;">
                            <div style="flex: 2; padding-left: 12px;">Name</div>
                            <div style="flex: 1;">Type</div>
                            <div style="flex: 1;">Status</div>
                            <div style="flex: 2;">Email</div>
                            <div style="flex: 2;">Phone</div>
                            <div style="flex: 2;">Address</div>
                            <div style="flex: 2;">Description</div>
                            <div style="flex: 1; text-align: right; padding-right: 12px;">Actions</div>
                        </div>
                        ${organizations.map(org => `
                            <div style="display: flex; align-items: center; border: 1px solid #eee; border-radius: 8px; padding: 12px 0 12px 0; background: #fafafa; margin-bottom: 8px;">
                                <div style="flex: 2; padding-left: 12px;"><a href="create-agent.html?org_id=${org.id}" style="color:#4f46e5; text-decoration:underline; cursor:pointer;">${org.name}</a></div>
                                <div style="flex: 1;">${org.type || ''}</div>
                                <div style="flex: 1;">${org.status || 'active'}</div>
                                <div style="flex: 2;">${org.contact_email || org.email || ''}</div>
                                <div style="flex: 2;">${org.contact_phone || org.phone || ''}</div>
                                <div style="flex: 2;">${org.address || ''}</div>
                                <div style="flex: 2;">${org.description || ''}</div>
                                <div style="flex: 1; display: flex; gap: 8px; justify-content: flex-end; padding-right: 12px;">
                                    <button onclick="viewOrganization('${org.id}')" title="View" style="background:none; border:none; cursor:pointer; color:#6366f1; font-size: 18px;">👁️</button>
                                    <button onclick="editOrganization('${org.id}')" title="Edit" style="background:none; border:none; cursor:pointer; color:#10b981; font-size: 18px;">✏️</button>
                                    <button onclick="window.location.href='purchase-phone.html?org_id=${org.id}'" title="Purchase Phone" style="background:none; border:none; cursor:pointer; color:#f59e42; font-size: 18px;">📞 Purchase Phone</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function fillOrganizationForm(org, disableAll) {
            console.log('fillOrganizationForm called with:', org, 'disableAll:', disableAll);
            console.log('🔍 Complete organization object keys:', Object.keys(org || {}));
            console.log('🔍 Organization data structure:', JSON.stringify(org, null, 2));
            
            // Ensure the form fields exist before setting values
            const nameField = document.getElementById('orgName');
            const typeField = document.getElementById('orgType');
            const statusField = document.getElementById('orgStatus');
            const emailField = document.getElementById('orgEmail');
            const phoneField = document.getElementById('orgPhone');
            const addressField = document.getElementById('orgAddress');
            const descriptionField = document.getElementById('orgDescription');
            
            console.log('Form fields found:', {
                nameField: !!nameField,
                typeField: !!typeField,
                statusField: !!statusField,
                emailField: !!emailField,
                phoneField: !!phoneField,
                addressField: !!addressField,
                descriptionField: !!descriptionField
            });
            
            // Fill form fields with organization data based on Supabase schema
            if (nameField) {
                nameField.value = org.name || '';
                console.log('Set name field:', nameField.value);
                nameField.disabled = disableAll;
            }
            if (typeField) {
                typeField.value = org.type || '';
                console.log('Set type field:', typeField.value);
                typeField.disabled = disableAll;
            }
            if (statusField) {
                statusField.value = org.status || 'active';
                console.log('Set status field:', statusField.value);
                statusField.disabled = disableAll;
            }
            if (emailField) {
                emailField.value = org.contact_email || org.email || org.contactEmail || '';
                console.log('Set email field:', emailField.value, 'from org data:', {contact_email: org.contact_email, email: org.email, contactEmail: org.contactEmail});
                emailField.disabled = disableAll;
            }
            if (phoneField) {
                phoneField.value = org.contact_phone || org.phone || org.contactPhone || '';
                console.log('Set phone field:', phoneField.value, 'from org data:', {contact_phone: org.contact_phone, phone: org.phone, contactPhone: org.contactPhone});
                phoneField.disabled = disableAll;
            }
            if (addressField) {
                addressField.value = org.address || '';
                console.log('Set address field:', addressField.value);
                addressField.disabled = disableAll;
            }
            if (descriptionField) {
                descriptionField.value = org.description || '';
                console.log('Set description field:', descriptionField.value);
                descriptionField.disabled = disableAll;
            }
            
            // Configure form for view or edit mode
            const formElements = document.querySelectorAll('#organizationForm input, #organizationForm select, #organizationForm textarea');
            const submitBtn = document.querySelector('#organizationForm button[type=\"submit\"]');
            const cancelBtn = document.querySelector('#organizationModal button[onclick=\"closeOrganizationModal()\"]');
            
            if (disableAll) {
                // VIEW MODE: Read-only
                console.log('Setting form to VIEW mode (read-only)');
                formElements.forEach(el => {
                    el.disabled = true;
                    el.style.backgroundColor = '#f3f4f6';
                    el.style.cursor = 'not-allowed';
                    el.style.color = '#6b7280';
                });
                
                if (submitBtn) submitBtn.style.display = 'none';
                if (cancelBtn) cancelBtn.textContent = 'Close';
                
            } else {
                // EDIT MODE: Editable
                console.log('Setting form to EDIT mode (editable)');
                formElements.forEach(el => {
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                    el.style.color = '';
                });
                
                if (submitBtn) {
                    submitBtn.style.display = 'block';
                    submitBtn.textContent = 'Save Changes';
                }
                if (cancelBtn) cancelBtn.textContent = 'Cancel';
            }
            
            console.log('Form configured for:', disableAll ? 'VIEW mode' : 'EDIT mode');
            
            // Final verification - check if form is actually filled
            setTimeout(() => {
                const nameValue = document.getElementById('orgName')?.value;
                const emailValue = document.getElementById('orgEmail')?.value;
                console.log('Form verification - Name:', nameValue, 'Email:', emailValue);
                if (!nameValue || !emailValue) {
                    console.error('WARNING: Form fields are empty after filling!');
                }
            }, 50);
        }

        // Helper functions
        function getTypeIcon(type) {
            const icons = {
                retail: 'store',
                services: 'briefcase',
                technology: 'laptop',
                finance: 'chart-line',
                other: 'building'
            };
            return icons[type] || 'building';
        }

        function getOrgAgentCount(org) {
            let count = 0;
            if (org.channels) {
                org.channels.forEach(channel => {
                    count += channel.agents?.length || 0;
                });
            }
            return count;
        }

        function showOrgEmptyState() {
            document.getElementById('organizationsContainer').style.display = 'none';
            document.getElementById('orgEmptyState').style.display = 'block';
        }

        // Organization CRUD operations
        function addOrganization() {
            window.currentEditingOrg = null;
            document.getElementById('orgModalTitle').textContent = 'Add New Organization';
            document.getElementById('organizationForm').reset();
            document.getElementById('organizationModal').classList.remove('hidden');
        }


        // Search and filter functions
        function searchOrganizations() {
            const searchTerm = document.getElementById('orgSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('orgStatusFilter').value;
            const typeFilter = document.getElementById('orgTypeFilter').value;
            
            filteredOrganizations = allOrganizations.filter(org => {
                const matchesSearch = org.name.toLowerCase().includes(searchTerm) ||
                                    (org.contact_email && org.contact_email.toLowerCase().includes(searchTerm)) ||
                                    (org.description && org.description.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || org.status === statusFilter;
                const matchesType = !typeFilter || org.type === typeFilter;
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            displayOrganizations();
        }

        function filterOrganizations() {
            searchOrganizations(); // Reuse search logic with filters
        }

        function toggleViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            document.getElementById('gridViewBtn').className = mode === 'grid' ? 
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            document.getElementById('listViewBtn').className = mode === 'list' ? 
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            
            displayOrganizations();
        }

        function refreshOrganizations() {
            loadOrganizations();
        }

        function exportOrganizations() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "Name,Type,Status,Email,Phone,Channels,Agents,Created\n" +
                filteredOrganizations.map(org => 
                    `"${org.name}","${org.type}","${org.status}","${org.contact_email || ''}","${org.contact_phone || ''}","${org.channels?.length || 0}","${getOrgAgentCount(org)}","${new Date(org.created_at).toLocaleDateString()}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "organizations.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Phone Number Management Functions
        let currentSearchResults = [];
        let selectedPhoneNumber = null;

        // Load owned phone numbers
        async function loadPhoneNumbers() {
            try {
                const response = await apiRequest('/api/phone-numbers/owned');
                const phoneNumbers = response.data || [];

                updatePhoneNumberStats(phoneNumbers);
                displayOwnedPhoneNumbers(phoneNumbers);

            } catch (error) {
                console.error('Error loading phone numbers:', error);
                document.getElementById('ownedPhoneNumbersTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i>
                            <p>Error loading phone numbers: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Update phone number statistics
        function updatePhoneNumberStats(phoneNumbers) {
            const ownedCount = phoneNumbers.length;
            const monthlyCost = phoneNumbers.reduce((total, num) => total + (num.monthly_cost || 0), 0);
            const providers = [...new Set(phoneNumbers.map(num => num.provider))];
            const countries = [...new Set(phoneNumbers.map(num => num.country_code))];

            document.getElementById('ownedNumbersCount').textContent = ownedCount;
            document.getElementById('monthlyPhoneCost').textContent = `$${monthlyCost.toFixed(2)}`;
            document.getElementById('activeProvidersCount').textContent = providers.length;
            document.getElementById('countriesCount').textContent = countries.length;
            document.getElementById('phoneNavCount').textContent = ownedCount;
        }

        // Display owned phone numbers
        function displayOwnedPhoneNumbers(phoneNumbers) {
            const tableBody = document.getElementById('ownedPhoneNumbersTable');

            if (phoneNumbers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                            <p>No phone numbers found. Click "Search Numbers" to get started.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = phoneNumbers.map(phone => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${phone.phone_number}</div>
                        <div class="text-sm text-gray-500">${phone.friendly_name || 'No name'}</div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getProviderBadgeClass(phone.provider)}">
                            ${phone.provider.charAt(0).toUpperCase() + phone.provider.slice(1)}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="mr-2">${getCountryFlag(phone.country_code)}</span>
                            <span>${phone.country_name || phone.country_code}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-1">
                            ${phone.capabilities?.voice ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Voice</span>' : ''}
                            ${phone.capabilities?.sms ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">SMS</span>' : ''}
                            ${phone.capabilities?.mms ? '<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">MMS</span>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium">$${(phone.monthly_cost || 0).toFixed(2)}</span>
                        <div class="text-xs text-gray-500">per month</div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(phone.status)}">
                            ${phone.status || 'Active'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="configurePhoneNumber('${phone.id}')" class="text-blue-600 hover:text-blue-800" title="Configure">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button onclick="releasePhoneNumber('${phone.id}', '${phone.phone_number}')" class="text-red-600 hover:text-red-800" title="Release">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Show phone search modal
        function showPhoneSearchModal() {
            document.getElementById('phoneSearchModal').classList.remove('hidden');
            document.getElementById('phoneSearchResults').classList.add('hidden');
            document.getElementById('phoneSearchLoading').classList.add('hidden');
        }

        // Close phone search modal
        function closePhoneSearchModal() {
            document.getElementById('phoneSearchModal').classList.add('hidden');
            currentSearchResults = [];
        }

        // Search for available phone numbers
        async function searchPhoneNumbers() {
            const country = document.getElementById('searchCountry').value;
            const areaCode = document.getElementById('searchAreaCode').value;
            const pattern = document.getElementById('searchPattern').value;
            const capabilities = document.getElementById('searchCapabilities').value;
            const includeTwilio = document.getElementById('searchTwilio').checked;
            const includeTelnyx = document.getElementById('searchTelnyx').checked;

            const providers = [];
            if (includeTwilio) providers.push('twilio');
            if (includeTelnyx) providers.push('telnyx');

            if (providers.length === 0) {
                alert('Please select at least one provider');
                return;
            }

            // Show loading state
            document.getElementById('phoneSearchLoading').classList.remove('hidden');
            document.getElementById('phoneSearchResults').classList.add('hidden');

            try {
                const searchParams = new URLSearchParams({
                    country_code: country,
                    providers: providers.join(','),
                    limit: '20'
                });

                if (areaCode) searchParams.append('area_code', areaCode);
                if (pattern) searchParams.append('pattern', pattern);
                if (capabilities) searchParams.append('capabilities', capabilities);

                const response = await apiRequest(`/api/phone-numbers/search?${searchParams}`);
                currentSearchResults = response.data || [];

                displaySearchResults(currentSearchResults);

            } catch (error) {
                console.error('Error searching phone numbers:', error);
                document.getElementById('phoneSearchLoading').classList.add('hidden');
                alert('Error searching phone numbers: ' + error.message);
            }
        }

        // Display search results
        function displaySearchResults(results) {
            document.getElementById('phoneSearchLoading').classList.add('hidden');
            document.getElementById('phoneSearchResults').classList.remove('hidden');

            const tableBody = document.getElementById('phoneSearchResultsTable');

            if (results.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                            <p>No phone numbers found matching your criteria.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = results.map(phone => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${phone.phone_number}</div>
                        <div class="text-sm text-gray-500">${phone.locality || ''} ${phone.region || ''}</div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getProviderBadgeClass(phone.provider)}">
                            ${phone.provider.charAt(0).toUpperCase() + phone.provider.slice(1)}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-1">
                            ${phone.capabilities?.voice ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Voice</span>' : ''}
                            ${phone.capabilities?.sms ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">SMS</span>' : ''}
                            ${phone.capabilities?.mms ? '<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">MMS</span>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium text-green-600">$${(phone.monthly_cost || 0).toFixed(2)}</span>
                        <div class="text-xs text-gray-500">per month</div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium">$${(phone.setup_cost || 0).toFixed(2)}</span>
                        <div class="text-xs text-gray-500">one-time</div>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="showPurchaseModal('${JSON.stringify(phone).replace(/'/g, "\\'")}'))"
                                class="btn btn-primary px-4 py-2 text-sm">
                            <i class="fas fa-shopping-cart mr-1"></i>
                            Purchase
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Show purchase confirmation modal
        function showPurchaseModal(phoneDataStr) {
            try {
                selectedPhoneNumber = JSON.parse(phoneDataStr);

                const modal = document.getElementById('phonePurchaseModal');
                const detailsDiv = document.getElementById('purchaseDetails');

                const totalCost = (selectedPhoneNumber.setup_cost || 0) + (selectedPhoneNumber.monthly_cost || 0);

                detailsDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Phone Number Details</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Number:</span>
                                    <span class="font-medium ml-2">${selectedPhoneNumber.phone_number}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Provider:</span>
                                    <span class="font-medium ml-2">${selectedPhoneNumber.provider.charAt(0).toUpperCase() + selectedPhoneNumber.provider.slice(1)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Country:</span>
                                    <span class="font-medium ml-2">${selectedPhoneNumber.country_name || selectedPhoneNumber.country_code}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Capabilities:</span>
                                    <div class="flex space-x-1 mt-1">
                                        ${selectedPhoneNumber.capabilities?.voice ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Voice</span>' : ''}
                                        ${selectedPhoneNumber.capabilities?.sms ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">SMS</span>' : ''}
                                        ${selectedPhoneNumber.capabilities?.mms ? '<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">MMS</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Pricing</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Setup Cost:</span>
                                    <span class="font-medium">$${(selectedPhoneNumber.setup_cost || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Monthly Cost:</span>
                                    <span class="font-medium">$${(selectedPhoneNumber.monthly_cost || 0).toFixed(2)}</span>
                                </div>
                                <div class="border-t pt-2 flex justify-between font-semibold">
                                    <span>Total (First Month):</span>
                                    <span class="text-green-600">$${totalCost.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                                <div class="text-sm text-blue-800">
                                    <p class="font-medium mb-1">Important Notes:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Phone number will be activated immediately after purchase</li>
                                        <li>Monthly charges will be billed automatically</li>
                                        <li>You can release the number anytime from your dashboard</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');

            } catch (error) {
                console.error('Error showing purchase modal:', error);
                alert('Error displaying purchase details');
            }
        }

        // Close purchase modal
        function closePurchaseModal() {
            document.getElementById('phonePurchaseModal').classList.add('hidden');
            selectedPhoneNumber = null;
        }

        // Confirm phone number purchase
        async function confirmPhonePurchase() {
            if (!selectedPhoneNumber) return;

            try {
                const response = await apiRequest('/api/phone-numbers/purchase', {
                    method: 'POST',
                    body: JSON.stringify({
                        provider: selectedPhoneNumber.provider,
                        phone_number: selectedPhoneNumber.phone_number,
                        friendly_name: `AgentSDR - ${selectedPhoneNumber.phone_number}`,
                        voice_url: window.location.origin + '/webhooks/voice',
                        sms_url: window.location.origin + '/webhooks/sms'
                    })
                });

                if (response.success) {
                    alert('✅ Phone number purchased successfully!');
                    closePurchaseModal();
                    closePhoneSearchModal();
                    loadPhoneNumbers(); // Refresh the owned numbers list
                } else {
                    throw new Error(response.error || 'Purchase failed');
                }

            } catch (error) {
                console.error('Error purchasing phone number:', error);
                alert('❌ Error purchasing phone number: ' + error.message);
            }
        }

        // Utility functions for phone number management
        function getProviderBadgeClass(provider) {
            switch (provider?.toLowerCase()) {
                case 'twilio': return 'bg-blue-100 text-blue-800';
                case 'telnyx': return 'bg-purple-100 text-purple-800';
                case 'plivo': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status?.toLowerCase()) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-red-100 text-red-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getCountryFlag(countryCode) {
            const flags = {
                'US': '🇺🇸', 'IN': '🇮🇳', 'GB': '🇬🇧', 'CA': '🇨🇦', 'AU': '🇦🇺',
                'DE': '🇩🇪', 'FR': '🇫🇷', 'JP': '🇯🇵', 'BR': '🇧🇷', 'MX': '🇲🇽'
            };
            return flags[countryCode] || '🌍';
        }

        // Filter and search functions
        function filterPhoneNumbers() {
            const searchTerm = document.getElementById('phoneNumberSearch').value.toLowerCase();
            const providerFilter = document.getElementById('providerFilter').value;

            // This would filter the displayed phone numbers
            // Implementation depends on how you store the current phone numbers
            console.log('Filtering phone numbers:', { searchTerm, providerFilter });
        }

        function sortSearchResults() {
            const sortBy = document.getElementById('sortResults').value;

            currentSearchResults.sort((a, b) => {
                switch (sortBy) {
                    case 'price':
                        return (a.monthly_cost || 0) - (b.monthly_cost || 0);
                    case 'provider':
                        return a.provider.localeCompare(b.provider);
                    case 'number':
                        return a.phone_number.localeCompare(b.phone_number);
                    default:
                        return 0;
                }
            });

            displaySearchResults(currentSearchResults);
        }

        // Phone number management actions
        function refreshPhoneNumbers() {
            loadPhoneNumbers();
        }

        function configurePhoneNumber(phoneId) {
            // Open configuration modal for the phone number
            alert(`Configure phone number ${phoneId} - Feature coming soon!`);
        }

        async function releasePhoneNumber(phoneId, phoneNumber) {
            if (!confirm(`Are you sure you want to release ${phoneNumber}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await apiRequest(`/api/phone-numbers/${phoneId}/release`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    alert('✅ Phone number released successfully!');
                    loadPhoneNumbers(); // Refresh the list
                } else {
                    throw new Error(response.error || 'Release failed');
                }

            } catch (error) {
                console.error('Error releasing phone number:', error);
                alert('❌ Error releasing phone number: ' + error.message);
            }
        }

        // Settings Tab Management
        function showSettingsTab(tabName) {
            // Hide all settings content
            const allSettingsContent = document.querySelectorAll('.settings-content');
            allSettingsContent.forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all navigation items
            const allNavItems = document.querySelectorAll('.settings-nav-item');
            allNavItems.forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected tab content
            const targetContent = document.getElementById(tabName + 'Settings');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            // Add active class to the clicked navigation item
            const clickedNavItem = event.target.closest('.settings-nav-item');
            if (clickedNavItem) {
                clickedNavItem.classList.add('active');
            }

            // Store the active tab in localStorage for persistence
            localStorage.setItem('activeSettingsTab', tabName);
        }

        // Initialize settings on page load
        function initializeSettings() {
            // Get the last active tab from localStorage or default to 'account'
            const activeTab = localStorage.getItem('activeSettingsTab') || 'account';

            // Find the corresponding navigation button and trigger click
            const navButtons = document.querySelectorAll('.settings-nav-item');
            navButtons.forEach((button, index) => {
                const tabNames = ['account', 'notifications', 'api', 'billing', 'security', 'advanced'];
                if (tabNames[index] === activeTab) {
                    // Remove active from all first
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active to current
                    button.classList.add('active');
                    // Show corresponding content
                    showSettingsTabContent(activeTab);
                }
            });
        }

        // Helper function to show settings tab content without event handling
        function showSettingsTabContent(tabName) {
            // Hide all settings content
            const allSettingsContent = document.querySelectorAll('.settings-content');
            allSettingsContent.forEach(content => {
                content.classList.add('hidden');
            });

            // Show the selected tab content
            const targetContent = document.getElementById(tabName + 'Settings');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
        }

        // Initialize settings when the settings section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize settings if settings section is visible
            const settingsSection = document.getElementById('settings');
            if (settingsSection && !settingsSection.style.display.includes('none')) {
                initializeSettings();
            }
        });

        // Header Button Functions
        function showNotifications() {
            // Create and show notifications dropdown
            const existingDropdown = document.getElementById('notificationsDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
                return;
            }

            const dropdown = document.createElement('div');
            dropdown.id = 'notificationsDropdown';
            dropdown.className = 'fixed top-16 right-4 w-80 glassmorphism rounded-2xl p-4 z-50 max-h-96 overflow-y-auto';
            dropdown.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-800">Notifications</h3>
                    <button onclick="markAllNotificationsRead()" class="text-sm text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
                <div class="space-y-3">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">New voice agent created</p>
                                <p class="text-xs text-gray-600">Customer Support Agent is now active</p>
                                <p class="text-xs text-gray-500 mt-1">2 minutes ago</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">Low credit balance</p>
                                <p class="text-xs text-gray-600">Your account balance is below ₹500</p>
                                <p class="text-xs text-gray-500 mt-1">1 hour ago</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">Campaign completed</p>
                                <p class="text-xs text-gray-600">Marketing Campaign #123 finished successfully</p>
                                <p class="text-xs text-gray-500 mt-1">3 hours ago</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <button onclick="showAllNotifications()" class="w-full text-center text-sm text-blue-600 hover:text-blue-800">View all notifications</button>
                </div>
            `;
            document.body.appendChild(dropdown);

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }

        function showGlobalSearch() {
            // Create and show search modal
            const existingModal = document.getElementById('globalSearchModal');
            if (existingModal) {
                existingModal.remove();
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'globalSearchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-2xl mx-4">
                    <div class="flex items-center space-x-4 mb-6">
                        <i class="fas fa-search text-gray-400"></i>
                        <input type="text" id="globalSearchInput" placeholder="Search agents, contacts, organizations..."
                               class="flex-1 bg-transparent border-none outline-none text-lg text-gray-800"
                               onkeyup="performGlobalSearch(this.value)">
                        <button onclick="closeGlobalSearch()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-search text-3xl mb-3"></i>
                            <p>Start typing to search...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('globalSearchInput').focus();

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const isVisible = sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === '';

            if (isVisible) {
                sidebar.style.transform = 'translateX(-100%)';
            } else {
                sidebar.style.transform = 'translateX(0px)';
            }
        }

        // Settings Functions
        function uploadProfilePicture() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg,image/png';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        return;
                    }
                    // Simulate upload
                    alert('Profile picture uploaded successfully!');
                }
            };
            input.click();
        }

        function copyApiKey(type) {
            const key = type === 'production' ? 'sk-prod-1234567890abcdef' : 'sk-dev-abcdef1234567890';
            navigator.clipboard.writeText(key).then(() => {
                // Show temporary success message
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                }, 2000);
            });
        }

        function regenerateApiKey(type) {
            if (confirm(`Are you sure you want to regenerate the ${type} API key? This will invalidate the current key.`)) {
                // Simulate API key regeneration
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} API key regenerated successfully!`);
            }
        }

        function generateNewApiKey() {
            const keyName = prompt('Enter a name for the new API key:');
            if (keyName) {
                alert(`New API key "${keyName}" generated successfully!`);
            }
        }

        function addPaymentMethod() {
            alert('Payment method setup will open in a new window.');
            // In a real implementation, this would open a payment processor modal
        }

        function editPaymentMethod(id) {
            alert(`Edit payment method ${id}`);
        }

        function showChangePasswordModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Change Password</h3>
                    <form onsubmit="changePassword(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="flex items-center justify-end space-x-3 mt-6">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary px-4 py-2">Cancel</button>
                            <button type="submit" class="btn btn-primary px-6 py-2">Change Password</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function changePassword(event) {
            event.preventDefault();
            // Simulate password change
            alert('Password changed successfully!');
            event.target.closest('.fixed').remove();
        }

        function signOutAllSessions() {
            if (confirm('Are you sure you want to sign out all sessions? You will need to log in again on all devices.')) {
                alert('All sessions signed out successfully!');
            }
        }

        function exportAccountData() {
            if (confirm('This will generate a download link for all your account data. Continue?')) {
                alert('Data export initiated. You will receive an email with the download link within 24 hours.');
            }
        }

        function showDeleteAccountModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-red-800 mb-6">Delete Account</h3>
                    <div class="mb-6">
                        <p class="text-gray-700 mb-4">This action cannot be undone. This will permanently delete your account and all associated data.</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-800 font-medium">Type "DELETE" to confirm:</p>
                            <input type="text" id="deleteConfirmation" class="w-full mt-2 px-3 py-2 border border-red-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex items-center justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary px-4 py-2">Cancel</button>
                        <button onclick="confirmDeleteAccount()" class="btn bg-red-600 text-white hover:bg-red-700 px-6 py-2">Delete Account</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmDeleteAccount() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            if (confirmation === 'DELETE') {
                alert('Account deletion initiated. You will receive a confirmation email.');
                document.querySelector('.fixed').remove();
            } else {
                alert('Please type "DELETE" to confirm account deletion.');
            }
        }

        // Helper functions for notifications and search
        function markAllNotificationsRead() {
            document.getElementById('notificationsDropdown').remove();
            // Update notification count
            document.querySelector('.notification-dot').style.display = 'none';
        }

        function showAllNotifications() {
            document.getElementById('notificationsDropdown').remove();
            alert('Full notifications page would open here.');
        }

        function closeGlobalSearch() {
            document.getElementById('globalSearchModal').remove();
        }

        function performGlobalSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            if (!query.trim()) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>Start typing to search...</p>
                    </div>
                `;
                return;
            }

            // Simulate search results
            resultsDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-robot text-blue-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">Customer Support Agent</p>
                                <p class="text-sm text-gray-600">Voice Agent • Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-user text-green-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">John Doe</p>
                                <p class="text-sm text-gray-600">Contact • +91 98765 43210</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-building text-purple-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">ABC Enterprises</p>
                                <p class="text-sm text-gray-600">Organization • 5 channels</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Missing Function Implementations

        // Authentication Functions
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                logout();
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-mode');

            if (isDark) {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Modal Functions
        function showCallsModal() {
            alert('Call campaign modal would open here. This feature allows you to start automated calling campaigns.');
        }


        function closePhoneSearchModal() {
            document.getElementById('phoneSearchModal').classList.add('hidden');
        }

        function closePurchaseModal() {
            document.getElementById('phonePurchaseModal').classList.add('hidden');
        }

        // Organization Functions
        function addOrganization() {
            document.getElementById('organizationModal').classList.remove('hidden');
            document.getElementById('orgModalTitle').textContent = 'Add New Organization';
        }


        // ✅ DELETE FUNCTION - Simplified to avoid API errors
        function deleteOrganization(orgId) {
            console.log('🔴 Delete Organization called with ID:', orgId);
            
            // Find organization from global data for confirmation
            const org = window.lastOrganizations?.find(o => o.id === orgId);
            const orgName = org?.name || 'this organization';
            
            if (!confirm(`Are you sure you want to delete "${orgName}"? This action cannot be undone and will also delete all associated channels, agents, and contacts.`)) {
                return;
            }
            
            // For now, show message since API endpoint doesn't exist
            console.log('💡 Delete organization endpoint not implemented yet');
            alert('Organization delete feature will be available soon!');
        }

        function viewOrganizationChannels(orgId) {
            currentOrganization = orgId;
            showSection('channels');
        }

        function exportOrganizations() {
            alert('Exporting organizations data...');
            // Simulate file download
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,Organization Name,Type,Status,Created Date\nABC Enterprises,Healthcare,Active,2024-01-15';
            link.download = 'organizations.csv';
            link.click();
        }

        function refreshOrganizations() {
            loadOrganizations();
            alert('Organizations data refreshed!');
        }

        // Channel Functions
        function addChannel() {
            alert('Add channel modal would open here.');
        }

        function selectChannelType(type) {
            alert(`Selected channel type: ${type}`);
        }

        // Agent Functions
        function addAgent() {
            alert('Add voice agent modal would open here.');
        }

        function editAgent(agentId) {
            alert(`Edit agent ${agentId}`);
        }

        function deleteAgent(agentId) {
            if (confirm('Are you sure you want to delete this voice agent?')) {
                alert(`Agent ${agentId} deleted successfully!`);
            }
        }

        function viewAgent(agentId) {
            currentAgent = agentId;
            showSection('contacts');
        }

        function toggleAgentView(view) {
            // Update button states
            document.getElementById('agentGridBtn').className = view === 'grid' ?
                'btn btn-primary p-2' : 'btn btn-secondary p-2';
            document.getElementById('agentListBtn').className = view === 'list' ?
                'btn btn-primary p-2' : 'btn btn-secondary p-2';
            alert(`Switched to ${view} view`);
        }

        // Contact Functions
        function addContact() {
            alert('Add contact modal would open here.');
        }

        function editContact(contactId) {
            alert(`Edit contact ${contactId}`);
        }

        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact?')) {
                alert(`Contact ${contactId} deleted successfully!`);
            }
        }

        function callContact(contactId) {
            alert(`Initiating call to contact ${contactId}`);
        }

        function importContacts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    alert(`Importing contacts from ${file.name}...`);
                }
            };
            input.click();
        }

        function exportContacts() {
            alert('Exporting contacts data...');
        }

        function bulkActions() {
            alert('Bulk actions panel would open here.');
        }

        function bulkEdit() {
            alert('Bulk edit modal would open here.');
        }

        function bulkDelete() {
            if (confirm('Are you sure you want to delete selected contacts?')) {
                alert('Selected contacts deleted successfully!');
            }
        }

        function clearContactSelection() {
            alert('Contact selection cleared.');
        }

        function toggleContactView(view) {
            document.getElementById('contactGridBtn').className = view === 'grid' ?
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            document.getElementById('contactListBtn').className = view === 'list' ?
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
        }

        function previousContactsPage() {
            alert('Previous page');
        }

        function nextContactsPage() {
            alert('Next page');
        }

        // Analytics Functions
        function exportAnalytics() {
            alert('Exporting analytics report...');
        }

        function toggleChartType(chartId, type) {
            alert(`Switching ${chartId} to ${type} chart`);
        }

        function generateCustomReport() {
            alert('Custom report generator would open here.');
        }

        // Settings Functions
        function saveAllSettings() {
            alert('All settings saved successfully!');
        }

        // Phone Number Functions
        function refreshPhoneNumbers() {
            loadPhoneNumbers();
            alert('Phone numbers refreshed!');
        }

        function showPhoneSearchModal() {
            document.getElementById('phoneSearchModal').classList.remove('hidden');
        }

        function searchPhoneNumbers() {
            alert('Searching for available phone numbers...');
        }

        function confirmPhonePurchase() {
            alert('Phone number purchased successfully!');
            closePurchaseModal();
        }

        function configurePhoneNumber(phoneId) {
            alert(`Configure phone number ${phoneId}`);
        }

        // Form Submission Functions
      
        // Auto-refresh data every 30 seconds
        setInterval(() => {
            // Simulate real-time updates
            const callCount = document.querySelector('.metric-card:last-child h3');
            const currentCount = parseInt(callCount.textContent.replace(',', ''));
            callCount.textContent = (currentCount + Math.floor(Math.random() * 3)).toLocaleString();
        }, 30000);

        function showOrganizationModal() {
            console.log('showOrganizationModal called');
            const modal = document.getElementById('organizationModal');
            console.log('Modal element found:', !!modal);
            
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.zIndex = '9999';
                // Ensure modal is properly centered
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                console.log('Modal should be visible now');
            } else {
                console.error('Modal element not found!');
            }
        }
        
        function hideOrganizationModal() {
            const modal = document.getElementById('organizationModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                
                // Reset form and clear states
                const form = document.getElementById('organizationForm');
                if (form) {
                    form.reset();
                }
                
                // Re-enable all form fields
                const formElements = document.querySelectorAll('#organizationForm input, #organizationForm select, #organizationForm textarea');
                formElements.forEach(el => {
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                    el.style.color = '';
                });
                
                // Clear editing state
                window.currentEditingOrg = null;
            }
        }
    </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Replace with your actual credentials
  const SUPABASE_URL = 'https://ymvfueudlippmfeqdqro.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdmZ1ZXVkbGlwcG1mZXFkcXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzUwMjcsImV4cCI6MjA2NzgxMTAyN30.tXWFK6xPhZzRF0v5AQxeKqmTS-piaIL6aT4s0o-b5aY';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function submitOrganization(event) {
    event.preventDefault();

    const typeValue = document.getElementById('orgType').value;
    if (!typeValue) {
      alert('Please select a valid organization type.');
      return;
    }

    const data = {
      name: document.getElementById('orgName').value,
      type: typeValue,
      status: document.getElementById('orgStatus').value,
      email: document.getElementById('orgEmail').value,
      phone: document.getElementById('orgPhone').value,
      address: document.getElementById('orgAddress').value,
      description: document.getElementById('orgDescription').value
    };

    let result;
    if (window.currentEditingOrg && window.currentEditingOrg.id) {
      // Edit mode: Update existing organization
      result = await supabase
        .from('organizations')
        .update(data)
        .eq('id', window.currentEditingOrg.id);
    } else {
      // Add mode: Insert new organization
      result = await supabase
        .from('organizations')
        .insert([data]);
    }

    if (result.error) {
      console.error('Supabase operation error:', result.error);
      alert('Error saving organization. Check console for details.');
    } else {
      alert('Organization saved successfully!');
      closeOrganizationModal();
      // Clear editing context
      window.currentEditingOrg = null;
      // Refresh organizations list
      loadOrganizations();
    }
  }



   // Fetch organizations for the current user only using Supabase
   async function fetchUserOrganizations() {
        if (!currentUser || !currentUser.user || !currentUser.user.id) {
            console.error('No current user found for fetching organizations.');
            return [];
        }
        const userId = currentUser.user.id;
        const { data, error } = await supabase
            .from('organizations')
            .select('*')
            .eq('user_id', userId);
        if (error) {
            console.error('Error fetching organizations:', error);
            return [];
        }
        console.log('Fetched organizations from API:', data);
        return data;
       
    }

    // Function to display organizations in the organizationsList div as rows only
    function displayOrganizations(organizations) {
        // We have real API data, no need for dummy data
        if (!organizations || organizations.length === 0) {
            console.log('No organizations found from API in second function');
            return;
        }
        
        // Store organizations globally for view/edit/delete operations
        window.lastOrganizations = organizations || [];
        
        const container = document.getElementById('organizationsList');
        if (!container) return;

        // Toggle empty state visibility
        const emptyState = document.getElementById('orgEmptyState');
        if (emptyState) {
            if (!organizations || organizations.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        }

        if (!organizations || organizations.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = `
            <div style="overflow-x: auto; max-width: 100%;">
                <div style="min-width: 1100px; max-height: 400px; overflow-y: auto;">
                    <div style="display: flex; font-weight: bold; background: #f3f4f6; border-bottom: 2px solid #ddd; padding: 10px 0;">
                        <div style="flex: 2; padding-left: 12px;">Name</div>
                        <div style="flex: 1;">Type</div>
                        <div style="flex: 1;">Status</div>
                        <div style="flex: 2;">Email</div>
                        <div style="flex: 2;">Phone</div>
                        <div style="flex: 2;">Address</div>
                        <div style="flex: 2;">Description</div>
                        <div style="flex: 1; text-align: right; padding-right: 12px;">Actions</div>
                    </div>
                    ${organizations.map(org => `
                        <div style="display: flex; align-items: center; border: 1px solid #eee; border-radius: 8px; padding: 12px 0 12px 0; background: #fafafa; margin-bottom: 8px;">
                            <div style="flex: 2; padding-left: 12px;"><a href="create-agent.html?org_id=${org.id}" style="color:#4f46e5; text-decoration:underline; cursor:pointer;">${org.name}</a></div>
                            <div style="flex: 1;">${org.type || ''}</div>
                            <div style="flex: 1;">${org.status || 'active'}</div>
                            <div style="flex: 2;">${org.contact_email || org.email || ''}</div>
                            <div style="flex: 2;">${org.contact_phone || org.phone || ''}</div>
                            <div style="flex: 2;">${org.address || ''}</div>
                            <div style="flex: 2;">${org.description || ''}</div>
                            <div style="flex: 1; display: flex; gap: 8px; justify-content: flex-end; padding-right: 12px;">
                                <button onclick="viewOrganization('${org.id}')" title="View" style="background:none; border:none; cursor:pointer; color:#6366f1; font-size: 18px;">👁️</button>
                                <button onclick="editOrganization('${org.id}')" title="Edit" style="background:none; border:none; cursor:pointer; color:#10b981; font-size: 18px;">✏️</button>
                                <button onclick="window.location.href='purchase-phone.html?org_id=${org.id}'" title="Purchase Phone" style="background:none; border:none; cursor:pointer; color:#f59e42; font-size: 18px;">📞 Purchase Phone</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Add the organizationsList div if it doesn't exist
    if (!document.getElementById('organizationsList')) {
        const orgDiv = document.createElement('div');
        orgDiv.id = 'organizationsList';
        orgDiv.style.margin = '32px auto';
        orgDiv.style.maxWidth = '600px';
        document.body.appendChild(orgDiv);
  }

  // HubSpot Integration Functions
  function connectHubSpot() {
    // Redirect to HubSpot OAuth flow
    window.location.href = '/api/crm/hubspot/auth';
  }

  async function disconnectHubSpot() {
    try {
      const response = await fetch('/api/crm/hubspot/disconnect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
        }
      });

      const result = await response.json();

      if (response.ok) {
        // Update UI to show disconnected state
        document.getElementById('hubspotStatus').textContent = 'Not Connected';
        document.getElementById('hubspotStatus').className = 'px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full';
        document.getElementById('hubspotConnectBtn').textContent = 'Connect';
        document.getElementById('hubspotConnectBtn').onclick = connectHubSpot;
        document.getElementById('hubspotConnected').classList.add('hidden');

        alert('HubSpot disconnected successfully!');
      } else {
        alert('Failed to disconnect HubSpot: ' + result.error);
      }
    } catch (error) {
      console.error('Error disconnecting HubSpot:', error);
      alert('Error disconnecting HubSpot. Please try again.');
    }
  }

  // Check HubSpot connection status on page load
  async function checkHubSpotStatus() {
    try {
      const response = await fetch('/api/crm/status', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
        }
      });

      const result = await response.json();

      if (response.ok && result.connected && result.crm_type === 'HubSpot') {
        // Update UI to show connected state
        document.getElementById('hubspotStatus').textContent = 'Connected';
        document.getElementById('hubspotStatus').className = 'px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full';
        document.getElementById('hubspotConnectBtn').textContent = 'Reconnect';
        document.getElementById('hubspotConnected').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error checking HubSpot status:', error);
    }
  }

  // Check for HubSpot connection success from URL parameters
  function checkHubSpotConnectionSuccess() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('hubspot_connected') === 'true') {
      // Update UI to show connected state
      document.getElementById('hubspotStatus').textContent = 'Connected';
      document.getElementById('hubspotStatus').className = 'px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full';
      document.getElementById('hubspotConnectBtn').textContent = 'Reconnect';
      document.getElementById('hubspotConnected').classList.remove('hidden');

      // Show success message
      alert('HubSpot connected successfully!');

      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  // HubSpot Contact Sync Functions
  async function syncHubSpotContacts() {
    try {
      const syncButton = document.querySelector('button[onclick="syncHubSpotContacts()"]');
      const statusDiv = document.getElementById('syncStatus');

      // Show loading state
      syncButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Syncing...';
      syncButton.disabled = true;
      statusDiv.className = 'mt-2 text-sm text-blue-600';
      statusDiv.textContent = 'Syncing contacts from HubSpot...';
      statusDiv.classList.remove('hidden');

      const response = await fetch('/api/crm/hubspot/sync-contacts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
        }
      });

      const result = await response.json();

      if (response.ok) {
        // Update UI with success
        statusDiv.className = 'mt-2 text-sm text-green-600';
        statusDiv.textContent = `✅ Synced ${result.synced_count} new contacts, updated ${result.updated_count} existing contacts`;

        // Update contact counts
        document.getElementById('hubspotContactCount').textContent = result.total_processed;
        document.getElementById('lastSyncTime').textContent = 'Just now';

        // Refresh CRM contacts if that section is visible
        if (document.getElementById('crmContacts').style.display !== 'none') {
          loadCRMContacts();
        }

        alert(`Contact sync successful!\n\nNew contacts: ${result.synced_count}\nUpdated contacts: ${result.updated_count}\nTotal processed: ${result.total_processed}`);
      } else {
        statusDiv.className = 'mt-2 text-sm text-red-600';
        statusDiv.textContent = `❌ Sync failed: ${result.error}`;
        alert('Contact sync failed: ' + result.error);
      }
    } catch (error) {
      console.error('Error syncing contacts:', error);
      document.getElementById('syncStatus').className = 'mt-2 text-sm text-red-600';
      document.getElementById('syncStatus').textContent = '❌ Sync failed: Network error';
      alert('Error syncing contacts. Please try again.');
    } finally {
      // Reset button state
      const syncButton = document.querySelector('button[onclick="syncHubSpotContacts()"]');
      syncButton.innerHTML = '<i class="fas fa-sync mr-1"></i> Sync Contacts';
      syncButton.disabled = false;
    }
  }

  async function viewHubSpotContacts() {
    // Switch to CRM Contacts section
    showSection('crmContacts');
    // Load the contacts
    await loadCRMContacts();
  }

  async function loadCRMContacts() {
    try {
      const response = await fetch('/api/crm/contacts', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
        }
      });

      const result = await response.json();

      if (response.ok) {
        displayCRMContacts(result.contacts);
        updateCRMStats(result.contacts);
      } else {
        console.error('Failed to load CRM contacts:', result.error);
      }
    } catch (error) {
      console.error('Error loading CRM contacts:', error);
    }
  }

  function displayCRMContacts(contacts) {
    const contactsList = document.getElementById('crmContactsList');
    const emptyState = document.getElementById('crmContactsEmptyState');

    if (!contacts || contacts.length === 0) {
      contactsList.innerHTML = '';
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    contactsList.innerHTML = contacts.map(contact => `
      <tr class="border-b border-gray-100 hover:bg-gray-50">
        <td class="py-3 px-4">
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold mr-3">
              ${(contact.first_name?.[0] || contact.email?.[0] || '?').toUpperCase()}
            </div>
            <div>
              <div class="font-medium text-gray-800">${contact.first_name || ''} ${contact.last_name || ''}</div>
              <div class="text-sm text-gray-500">${contact.email || 'No email'}</div>
            </div>
          </div>
        </td>
        <td class="py-3 px-4 text-gray-600">${contact.email || '-'}</td>
        <td class="py-3 px-4 text-gray-600">${contact.phone || '-'}</td>
        <td class="py-3 px-4 text-gray-600">${contact.company || '-'}</td>
        <td class="py-3 px-4">
          <span class="px-2 py-1 text-xs rounded-full ${contact.source === 'hubspot' ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
            ${contact.source || 'Unknown'}
          </span>
        </td>
        <td class="py-3 px-4">
          <span class="px-2 py-1 text-xs rounded-full ${contact.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
            ${contact.status || 'Unknown'}
          </span>
        </td>
        <td class="py-3 px-4">
          <div class="flex items-center space-x-2">
            <button onclick="callContact('${contact.id}')" class="text-blue-600 hover:text-blue-800" title="Call Contact">
              <i class="fas fa-phone"></i>
            </button>
            <button onclick="editContact('${contact.id}')" class="text-gray-600 hover:text-gray-800" title="Edit Contact">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function updateCRMStats(contacts) {
    const hubspotContacts = contacts.filter(c => c.source === 'hubspot').length;
    const totalContacts = contacts.length;

    document.getElementById('hubspotContactCount').textContent = hubspotContacts;
    document.getElementById('totalCRMContacts').textContent = totalContacts;
    document.getElementById('crmContactNavCount').textContent = totalContacts;
  }

  async function syncAllCRMContacts() {
    // For now, just sync HubSpot
    await syncHubSpotContacts();
  }

  function exportCRMContacts() {
    alert('Export functionality coming soon!');
  }

  function callContact(contactId) {
    alert(`Calling contact ${contactId} - Voice agent integration coming soon!`);
  }

  function editContact(contactId) {
    alert(`Edit contact ${contactId} - Contact editing coming soon!`);
  }

  // Initialize HubSpot status check when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkHubSpotConnectionSuccess();
    checkHubSpotStatus();

    // Load CRM contacts if on that section
    if (window.location.hash === '#crmContacts') {
      showSection('crmContacts');
      loadCRMContacts();
    }
  });
</script>

   
</body>
</html>
